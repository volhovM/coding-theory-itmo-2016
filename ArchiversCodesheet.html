<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-12-18 Sun 17:00 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title>Information theory: HW #3 code listing</title>
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Volkhov Mikhail, M3338" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Information theory: HW #3 code listing</h1>
<div class="org-src-container">

<pre class="src src-haskell"><span class="linenr">  1: </span><span style="color: #8fbfdc;">{-#</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">LANGUAGE</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">FlexibleContexts</span><span style="color: #333333;">    </span><span style="color: #8fbfdc;">#-}</span>
<span class="linenr">  2: </span><span style="color: #8fbfdc;">{-#</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">LANGUAGE</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">MultiWayIf</span><span style="color: #333333;">          </span><span style="color: #8fbfdc;">#-}</span>
<span class="linenr">  3: </span><span style="color: #8fbfdc;">{-#</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">LANGUAGE</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">OverloadedStrings</span><span style="color: #333333;">   </span><span style="color: #8fbfdc;">#-}</span>
<span class="linenr">  4: </span><span style="color: #8fbfdc;">{-#</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">LANGUAGE</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">ScopedTypeVariables</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">#-}</span>
<span class="linenr">  5: </span><span style="color: #8fbfdc;">{-#</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">LANGUAGE</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">TemplateHaskell</span><span style="color: #333333;">     </span><span style="color: #8fbfdc;">#-}</span>
<span class="linenr">  6: </span><span style="color: #8fbfdc;">{-#</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">LANGUAGE</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">TupleSections</span><span style="color: #333333;">       </span><span style="color: #8fbfdc;">#-}</span>
<span class="linenr">  7: </span><span style="color: #8fbfdc;">{-#</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">LANGUAGE</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">TypeApplications</span><span style="color: #333333;">    </span><span style="color: #8fbfdc;">#-}</span>
<span class="linenr">  8: </span><span style="color: #8fbfdc;">{-#</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">LANGUAGE</span><span style="color: #333333;"> </span><span style="color: #8fbfdc;">ViewPatterns</span><span style="color: #333333;">        </span><span style="color: #8fbfdc;">#-}</span>
<span class="linenr">  9: </span>
<span class="linenr"> 10: </span><span style="color: #868B44;">--</span><span style="color: #333333;"> </span><span style="color: #868B44;">|</span><span style="color: #333333;"> </span><span style="color: #868B44;">Homework</span><span style="color: #333333;"> </span><span style="color: #868B44;">3</span>
<span class="linenr"> 11: </span>
<span class="linenr"> 12: </span><span style="color: #FFA070;">module</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Archivers</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span><span style="color: #333333;"> </span><span style="color: #FFA070;">where</span>
<span class="linenr"> 13: </span>
<span class="linenr"> 14: </span><span style="color: #FFA070;">import</span><span style="color: #333333;"> </span><span style="color: #FFA070;">qualified</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Base</span><span style="color: #333333;">                   </span><span style="color: #FFA070;">as</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">B</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Show</span><span style="color: #333333;"> </span>(<span style="color: #A197BF;">..</span>))
<span class="linenr"> 15: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Codec.Compression.GZip</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">CompressParams</span><span style="color: #333333;"> </span>(<span style="color: #A197BF;">..</span>))
<span class="linenr"> 16: </span><span style="color: #FFA070;">import</span><span style="color: #333333;"> </span><span style="color: #FFA070;">qualified</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Codec.Compression.GZip</span><span style="color: #333333;"> </span><span style="color: #FFA070;">as</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Z</span>
<span class="linenr"> 17: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Control.Exception</span><span style="color: #333333;">      </span>(assert)
<span class="linenr"> 18: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Control.Lens</span><span style="color: #333333;">           </span>(makeLenses,<span style="color: #333333;"> </span>to,<span style="color: #333333;"> </span>use,<span style="color: #333333;"> </span>uses,<span style="color: #333333;"> </span>view,<span style="color: #333333;"> </span>(<span style="color: #A197BF;">%=</span>),<span style="color: #333333;"> </span>(<span style="color: #A197BF;">+=</span>),
<span class="linenr"> 19: </span><span style="color: #333333;">                                         </span>(<span style="color: #A197BF;">.=</span>),<span style="color: #333333;"> </span>(<span style="color: #A197BF;">&lt;&gt;=</span>),<span style="color: #333333;"> </span>(<span style="color: #A197BF;">^.</span>),<span style="color: #333333;"> </span>_1,<span style="color: #333333;"> </span>_2,<span style="color: #333333;"> </span>_3)
<span class="linenr"> 20: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Control.Monad.Writer</span><span style="color: #333333;">   </span>(<span style="color: #EF5C5F;">MonadWriter</span>,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">Writer</span>,<span style="color: #333333;"> </span>runWriter,<span style="color: #333333;"> </span>tell)
<span class="linenr"> 21: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Data.Bifunctor</span><span style="color: #333333;">         </span>(first,<span style="color: #333333;"> </span>second)
<span class="linenr"> 22: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Data.Bits</span><span style="color: #333333;">              </span>(testBit)
<span class="linenr"> 23: </span><span style="color: #FFA070;">import</span><span style="color: #333333;"> </span><span style="color: #FFA070;">qualified</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Data.ByteString</span><span style="color: #333333;">        </span><span style="color: #FFA070;">as</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">BS</span>
<span class="linenr"> 24: </span><span style="color: #FFA070;">import</span><span style="color: #333333;"> </span><span style="color: #FFA070;">qualified</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Data.ByteString.Char8</span><span style="color: #333333;">  </span><span style="color: #FFA070;">as</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">BSC</span>
<span class="linenr"> 25: </span><span style="color: #FFA070;">import</span><span style="color: #333333;"> </span><span style="color: #FFA070;">qualified</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Data.ByteString.Lazy</span><span style="color: #333333;">   </span><span style="color: #FFA070;">as</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">BSL</span>
<span class="linenr"> 26: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Data.List</span><span style="color: #333333;">              </span>(dropWhileEnd,<span style="color: #333333;"> </span>findIndex,<span style="color: #333333;"> </span>last,<span style="color: #333333;"> </span>nub,<span style="color: #333333;"> </span>(<span style="color: #A197BF;">!!</span>))
<span class="linenr"> 27: </span><span style="color: #FFA070;">import</span><span style="color: #333333;"> </span><span style="color: #FFA070;">qualified</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Data.Map.Strict</span><span style="color: #333333;">        </span><span style="color: #FFA070;">as</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">M</span>
<span class="linenr"> 28: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Data.Maybe</span><span style="color: #333333;">             </span>(fromJust,<span style="color: #333333;"> </span>mapMaybe)
<span class="linenr"> 29: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Data.Number.BigFloat</span><span style="color: #333333;">   </span>(<span style="color: #EF5C5F;">BigFloat</span><span style="color: #333333;"> </span>(<span style="color: #A197BF;">..</span>),<span style="color: #333333;"> </span><span style="color: #EF5C5F;">Prec50</span>,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">PrecPlus20</span>)
<span class="linenr"> 30: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Data.Ord</span><span style="color: #333333;">               </span>(comparing)
<span class="linenr"> 31: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Data.Ratio</span><span style="color: #333333;">             </span>(denominator,<span style="color: #333333;"> </span>numerator,<span style="color: #333333;"> </span>(<span style="color: #A197BF;">%</span>))
<span class="linenr"> 32: </span><span style="color: #FFA070;">import</span><span style="color: #333333;"> </span><span style="color: #FFA070;">qualified</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Data.Text</span><span style="color: #333333;">              </span><span style="color: #FFA070;">as</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">T</span>
<span class="linenr"> 33: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Data.Word</span><span style="color: #333333;">              </span>(<span style="color: #EF5C5F;">Word16</span>)
<span class="linenr"> 34: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Numeric</span><span style="color: #333333;">                </span>(showGFloat)
<span class="linenr"> 35: </span><span style="color: #FFA070;">import</span><span style="color: #333333;">           </span><span style="color: #EF5C5F;">Universum</span><span style="color: #333333;">              </span><span style="color: #FFA070;">hiding</span><span style="color: #333333;"> </span>((<span style="color: #A197BF;">%</span>))
<span class="linenr"> 36: </span>
<span class="linenr"> 37: </span><span style="color: #FFA070;">type</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">String</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Char</span>]
<span class="linenr"> 38: </span>
<span class="linenr"> 39: </span><span style="color: #8AAFFA;">dropEnd</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[a]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[a]
<span class="linenr"> 40: </span><span style="color: #8AAFFA;">dropEnd</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span>xs<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>take<span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span>xs<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>i)<span style="color: #333333;"> </span>xs
<span class="linenr"> 41: </span>
<span class="linenr"> 42: </span><span style="color: #8AAFFA;">takeEnd</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[a]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[a]
<span class="linenr"> 43: </span><span style="color: #8AAFFA;">takeEnd</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span>xs<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>drop<span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span>xs<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>i)<span style="color: #333333;"> </span>xs
<span class="linenr"> 44: </span>
<span class="linenr"> 45: </span><span style="color: #8AAFFA;">log2</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Floating</span><span style="color: #333333;"> </span>a<span style="color: #333333;"> </span><span style="color: #A197BF;">=&gt;</span><span style="color: #333333;"> </span>a<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>a
<span class="linenr"> 46: </span><span style="color: #8AAFFA;">log2</span><span style="color: #333333;"> </span>k<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>log<span style="color: #333333;"> </span>k<span style="color: #333333;"> </span><span style="color: #A197BF;">/</span><span style="color: #333333;"> </span>log<span style="color: #333333;"> </span>2
<span class="linenr"> 47: </span><span style="color: #8AAFFA;">log2'</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>log2<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>fromIntegral
<span class="linenr"> 48: </span>
<span class="linenr"> 49: </span><span style="color: #8AAFFA;">proverb</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span>
<span class="linenr"> 50: </span><span style="color: #8AAFFA;">proverb</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr"> 51: </span><span style="color: #333333;">    </span>encodeUtf8
<span class="linenr"> 52: </span><span style="color: #333333;">        </span>(<span style="color: #868B44;">"Love_the_heart_that_hurts_you,_but_never_hurt_the_heart_that_loves_you."</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Text</span>)
<span class="linenr"> 53: </span>
<span class="linenr"> 54: </span><span style="color: #8AAFFA;">testProverb</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span>
<span class="linenr"> 55: </span><span style="color: #8AAFFA;">testProverb</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr"> 56: </span><span style="color: #333333;">    </span>encodeUtf8
<span class="linenr"> 57: </span><span style="color: #333333;">        </span>(<span style="color: #868B44;">"if_we_cannot_do_as_we_would_we_should_do_as_we_can"</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Text</span>)
<span class="linenr"> 58: </span>
<span class="linenr"> 59: </span><span style="color: #8AAFFA;">loremIpsum</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span>
<span class="linenr"> 60: </span><span style="color: #8AAFFA;">loremIpsum</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>encodeUtf8<span style="color: #333333;"> </span>(
<span class="linenr"> 61: </span><span style="color: #333333;">    </span><span style="color: #868B44;">"Lorem</span><span style="color: #333333;"> </span><span style="color: #868B44;">ipsum</span><span style="color: #333333;"> </span><span style="color: #868B44;">dolor</span><span style="color: #333333;"> </span><span style="color: #868B44;">sit</span><span style="color: #333333;"> </span><span style="color: #868B44;">amet,</span><span style="color: #333333;"> </span><span style="color: #868B44;">consectetur</span><span style="color: #333333;"> </span><span style="color: #868B44;">adipiscing</span><span style="color: #333333;"> </span><span style="color: #868B44;">elit.</span><span style="color: #333333;"> </span><span style="color: #868B44;">\</span>
<span class="linenr"> 62: </span><span style="color: #333333;">    </span><span style="color: #868B44;">\Cras</span><span style="color: #333333;"> </span><span style="color: #868B44;">ornare</span><span style="color: #333333;"> </span><span style="color: #868B44;">diam</span><span style="color: #333333;"> </span><span style="color: #868B44;">nec</span><span style="color: #333333;"> </span><span style="color: #868B44;">interdum</span><span style="color: #333333;"> </span><span style="color: #868B44;">mollis.</span><span style="color: #333333;"> </span><span style="color: #868B44;">Phasellus</span><span style="color: #333333;"> </span><span style="color: #868B44;">tortor</span><span style="color: #333333;"> </span><span style="color: #868B44;">felis,</span><span style="color: #333333;"> </span><span style="color: #868B44;">\</span>
<span class="linenr"> 63: </span><span style="color: #333333;">    </span><span style="color: #868B44;">\dapibus</span><span style="color: #333333;"> </span><span style="color: #868B44;">eu</span><span style="color: #333333;"> </span><span style="color: #868B44;">bibendum</span><span style="color: #333333;"> </span><span style="color: #868B44;">eu,</span><span style="color: #333333;"> </span><span style="color: #868B44;">commodo</span><span style="color: #333333;"> </span><span style="color: #868B44;">quis</span><span style="color: #333333;"> </span><span style="color: #868B44;">erat.</span><span style="color: #333333;"> </span><span style="color: #868B44;">Vestibulum</span><span style="color: #333333;"> </span><span style="color: #868B44;">fringilla,</span><span style="color: #333333;"> </span><span style="color: #868B44;">\</span>
<span class="linenr"> 64: </span><span style="color: #333333;">    </span><span style="color: #868B44;">\purus</span><span style="color: #333333;"> </span><span style="color: #868B44;">semper</span><span style="color: #333333;"> </span><span style="color: #868B44;">eleifend</span><span style="color: #333333;"> </span><span style="color: #868B44;">laoreet,</span><span style="color: #333333;"> </span><span style="color: #868B44;">sem</span><span style="color: #333333;"> </span><span style="color: #868B44;">dui</span><span style="color: #333333;"> </span><span style="color: #868B44;">volutpat</span><span style="color: #333333;"> </span><span style="color: #868B44;">lectus,</span><span style="color: #333333;"> </span><span style="color: #868B44;">sed</span><span style="color: #333333;"> </span><span style="color: #868B44;">ullamcorper</span><span style="color: #333333;"> </span><span style="color: #868B44;">\</span>
<span class="linenr"> 65: </span><span style="color: #333333;">    </span><span style="color: #868B44;">\ante</span><span style="color: #333333;"> </span><span style="color: #868B44;">neque</span><span style="color: #333333;"> </span><span style="color: #868B44;">id</span><span style="color: #333333;"> </span><span style="color: #868B44;">lectus.</span><span style="color: #333333;"> </span><span style="color: #868B44;">Nulla</span><span style="color: #333333;"> </span><span style="color: #868B44;">ullamcorper</span><span style="color: #333333;"> </span><span style="color: #868B44;">egestas</span><span style="color: #333333;"> </span><span style="color: #868B44;">nisl,</span><span style="color: #333333;"> </span><span style="color: #868B44;">at</span><span style="color: #333333;"> </span><span style="color: #868B44;">convallis</span><span style="color: #333333;"> </span><span style="color: #868B44;">\</span>
<span class="linenr"> 66: </span><span style="color: #333333;">    </span><span style="color: #868B44;">\leo</span><span style="color: #333333;"> </span><span style="color: #868B44;">tempus</span><span style="color: #333333;"> </span><span style="color: #868B44;">vel.</span><span style="color: #333333;"> </span><span style="color: #868B44;">Sed</span><span style="color: #333333;"> </span><span style="color: #868B44;">mi</span><span style="color: #333333;"> </span><span style="color: #868B44;">lacus,</span><span style="color: #333333;"> </span><span style="color: #868B44;">aliquam</span><span style="color: #333333;"> </span><span style="color: #868B44;">ullamcorper</span><span style="color: #333333;"> </span><span style="color: #868B44;">purus</span><span style="color: #333333;"> </span><span style="color: #868B44;">vitae,</span><span style="color: #333333;"> </span><span style="color: #868B44;">vulputate</span><span style="color: #333333;"> </span><span style="color: #868B44;">\</span>
<span class="linenr"> 67: </span><span style="color: #333333;">    </span><span style="color: #868B44;">\dignissim</span><span style="color: #333333;"> </span><span style="color: #868B44;">ipsum.</span><span style="color: #333333;"> </span><span style="color: #868B44;">Nam</span><span style="color: #333333;"> </span><span style="color: #868B44;">in</span><span style="color: #333333;"> </span><span style="color: #868B44;">est</span><span style="color: #333333;"> </span><span style="color: #868B44;">eu</span><span style="color: #333333;"> </span><span style="color: #868B44;">quam</span><span style="color: #333333;"> </span><span style="color: #868B44;">maximus</span><span style="color: #333333;"> </span><span style="color: #868B44;">blandit.</span><span style="color: #333333;"> </span><span style="color: #868B44;">Integer</span><span style="color: #333333;"> </span><span style="color: #868B44;">nec</span><span style="color: #333333;"> </span><span style="color: #868B44;">iaculis</span><span style="color: #333333;"> </span><span style="color: #868B44;">\</span>
<span class="linenr"> 68: </span><span style="color: #333333;">    </span><span style="color: #868B44;">\felis.</span><span style="color: #333333;"> </span><span style="color: #868B44;">Vestibulum</span><span style="color: #333333;"> </span><span style="color: #868B44;">ut</span><span style="color: #333333;"> </span><span style="color: #868B44;">cras</span><span style="color: #333333;"> </span><span style="color: #868B44;">amet.</span><span style="color: #333333;"> </span><span style="color: #868B44;">"</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Text</span>)
<span class="linenr"> 69: </span>
<span class="linenr"> 70: </span>
<span class="linenr"> 71: </span><span style="color: #FFA070;">newtype</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Logger</span><span style="color: #333333;"> </span>w<span style="color: #333333;"> </span>a<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Logger</span>
<span class="linenr"> 72: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>getLogger<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Writer</span><span style="color: #333333;"> </span>[w]<span style="color: #333333;"> </span>a
<span class="linenr"> 73: </span><span style="color: #333333;">    </span>}<span style="color: #333333;"> </span><span style="color: #FFA070;">deriving</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Functor</span>,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">Applicative</span>,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">Monad</span>,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">MonadWriter</span><span style="color: #333333;"> </span>[w])
<span class="linenr"> 74: </span>
<span class="linenr"> 75: </span><span style="color: #8AAFFA;">fromWord8</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Char</span>]
<span class="linenr"> 76: </span><span style="color: #8AAFFA;">fromWord8</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>map<span style="color: #333333;"> </span>(chr<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>fromIntegral)
<span class="linenr"> 77: </span>
<span class="linenr"> 78: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr"> 79: </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">Huffman</span>
<span class="linenr"> 80: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr"> 81: </span>
<span class="linenr"> 82: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">HuffmanTrace</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">HuffmanTrace</span>
<span class="linenr"> 83: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>hCurChar<span style="color: #333333;">   </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Char</span>
<span class="linenr"> 84: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>hProb<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Ratio</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr"> 85: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>hCodeWord<span style="color: #333333;">  </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">String</span>
<span class="linenr"> 86: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>hMsgLength<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr"> 87: </span><span style="color: #333333;">    </span>}
<span class="linenr"> 88: </span>
<span class="linenr"> 89: </span><span style="color: #FFA070;">instance</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">HuffmanTrace</span><span style="color: #333333;"> </span><span style="color: #FFA070;">where</span>
<span class="linenr"> 90: </span><span style="color: #333333;">    </span>show<span style="color: #333333;"> </span><span style="color: #EF5C5F;">HuffmanTrace</span><span style="color: #333333;"> </span>{<span style="color: #A197BF;">..</span>}<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr"> 91: </span><span style="color: #333333;">        </span>intercalate
<span class="linenr"> 92: </span><span style="color: #333333;">            </span><span style="color: #868B44;">"|"</span>
<span class="linenr"> 93: </span><span style="color: #333333;">            </span>[[hCurChar],<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>hProb,<span style="color: #333333;"> </span>hCodeWord,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>hMsgLength]
<span class="linenr"> 94: </span>
<span class="linenr"> 95: </span><span style="color: #8AAFFA;">huffman</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">BSC.ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Logger</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">HuffmanTrace</span><span style="color: #333333;"> </span>((<span style="color: #EF5C5F;">Map</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Char</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">String</span>,<span style="color: #EF5C5F;">Int</span>)),<span style="color: #EF5C5F;">String</span>)
<span class="linenr"> 96: </span><span style="color: #8AAFFA;">huffman</span><span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>encode<span style="color: #333333;"> </span>0<span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span>
<span class="linenr"> 97: </span><span style="color: #333333;">  </span><span style="color: #FFA070;">where</span>
<span class="linenr"> 98: </span><span style="color: #333333;">    </span>encode<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span>s<span style="color: #333333;"> </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">&gt;=</span><span style="color: #333333;"> </span>BSC.length<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>pure<span style="color: #333333;"> </span>(table1,<span style="color: #333333;"> </span>s)
<span class="linenr"> 99: </span><span style="color: #333333;">    </span>encode<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span>s<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">100: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>c<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">`BSC.index`</span><span style="color: #333333;"> </span>i
<span class="linenr">101: </span><span style="color: #333333;">            </span>(codeWord,m)<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>table1<span style="color: #333333;"> </span><span style="color: #A197BF;">M.!</span><span style="color: #333333;"> </span>c
<span class="linenr">102: </span><span style="color: #333333;">            </span>cl<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>codeWord
<span class="linenr">103: </span><span style="color: #333333;">            </span>s'<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>s<span style="color: #333333;"> </span><span style="color: #A197BF;">++</span><span style="color: #333333;"> </span>codeWord
<span class="linenr">104: </span><span style="color: #333333;">            </span>hProb<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>m<span style="color: #333333;"> </span><span style="color: #A197BF;">%</span><span style="color: #333333;"> </span>n
<span class="linenr">105: </span><span style="color: #333333;">            </span>hMsgLength<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>s'
<span class="linenr">106: </span><span style="color: #333333;">        </span>tell<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">HuffmanTrace</span><span style="color: #333333;"> </span>{hCurChar<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>c,<span style="color: #333333;"> </span>hCodeWord<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>codeWord,<span style="color: #333333;"> </span><span style="color: #A197BF;">..</span>}]
<span class="linenr">107: </span><span style="color: #333333;">        </span>encode<span style="color: #333333;"> </span>(i<span style="color: #A197BF;">+</span>1)<span style="color: #333333;"> </span>s'
<span class="linenr">108: </span><span style="color: #333333;">    </span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>BSC.length<span style="color: #333333;"> </span>input
<span class="linenr">109: </span><span style="color: #333333;">    </span>firstPass<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Map</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Char</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">110: </span><span style="color: #333333;">    </span>firstPass<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>BSC.foldr'<span style="color: #333333;"> </span>(M.alter<span style="color: #333333;"> </span>(pure<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>maybe<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span>(<span style="color: #A197BF;">+</span>1)))<span style="color: #333333;"> </span>M.empty<span style="color: #333333;"> </span>input
<span class="linenr">111: </span><span style="color: #333333;">    </span>calcWords<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[(<span style="color: #EF5C5F;">Double</span>,[(<span style="color: #EF5C5F;">Char</span>,<span style="color: #EF5C5F;">Int</span>)])]
<span class="linenr">112: </span><span style="color: #333333;">    </span>calcWords<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">113: </span><span style="color: #333333;">        </span>map<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>(k,<span style="color: #333333;"> </span>x)<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>(fromIntegral<span style="color: #333333;"> </span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">/</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span>n,[(k,0)]))<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>M.assocs<span style="color: #333333;"> </span>firstPass
<span class="linenr">114: </span><span style="color: #333333;">    </span>calcCodeWordDo<span style="color: #333333;"> </span>[(p,x)]<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>assert<span style="color: #333333;"> </span>(p<span style="color: #333333;"> </span><span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>1)<span style="color: #333333;"> </span>x
<span class="linenr">115: </span><span style="color: #333333;">    </span>calcCodeWordDo<span style="color: #333333;"> </span>(sortOn<span style="color: #333333;"> </span>fst<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>((p0,lefts)<span style="color: #EF5C5F;">:</span>(p1,rights)<span style="color: #EF5C5F;">:</span>xs))<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">116: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>inc<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>map<span style="color: #333333;"> </span>(second<span style="color: #333333;"> </span>(<span style="color: #A197BF;">+</span>1))
<span class="linenr">117: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">in</span><span style="color: #333333;"> </span>calcCodeWordDo<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>sortOn<span style="color: #333333;"> </span>fst<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>(p0<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>p1,<span style="color: #333333;"> </span>inc<span style="color: #333333;"> </span>lefts<span style="color: #333333;"> </span><span style="color: #A197BF;">++</span><span style="color: #333333;"> </span>inc<span style="color: #333333;"> </span>rights)<span style="color: #EF5C5F;">:</span>xs
<span class="linenr">118: </span><span style="color: #333333;">    </span>codeWords<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[(<span style="color: #EF5C5F;">Char</span>,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">String</span>)]
<span class="linenr">119: </span><span style="color: #333333;">    </span>codeWords<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>res<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>sortOn<span style="color: #333333;"> </span>snd<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>calcCodeWordDo<span style="color: #333333;"> </span>calcWords
<span class="linenr">120: </span><span style="color: #333333;">                </span><span style="color: #FFA070;">in</span><span style="color: #333333;"> </span>foldl'<span style="color: #333333;"> </span>codeNext<span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span>res
<span class="linenr">121: </span><span style="color: #333333;">    </span>codeNext<span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span>(c,l)<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>[(c,<span style="color: #333333;"> </span>replicate<span style="color: #333333;"> </span>l<span style="color: #333333;"> </span><span style="color: #868B44;">'0'</span>)]
<span class="linenr">122: </span><span style="color: #333333;">    </span>codeNext<span style="color: #333333;"> </span>xs<span style="color: #A197BF;">@</span>((<span style="color: #FFA070;">_</span>,pr)<span style="color: #EF5C5F;">:</span><span style="color: #FFA070;">_</span>)<span style="color: #333333;"> </span>(c,l)<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">123: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">generates</span><span style="color: #333333;"> </span><span style="color: #637579;">next</span><span style="color: #333333;"> </span><span style="color: #637579;">codeword</span><span style="color: #333333;"> </span><span style="color: #637579;">after</span><span style="color: #333333;"> </span><span style="color: #637579;">pr</span><span style="color: #333333;"> </span><span style="color: #637579;">of</span><span style="color: #333333;"> </span><span style="color: #637579;">length</span><span style="color: #333333;"> </span><span style="color: #637579;">l</span>
<span class="linenr">124: </span><span style="color: #333333;">            </span>nextWord<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>pr'<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>dropEnd<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>dropWhileEnd<span style="color: #333333;"> </span>(<span style="color: #A197BF;">==</span><span style="color: #333333;"> </span><span style="color: #868B44;">'1'</span>)<span style="color: #333333;"> </span>pr
<span class="linenr">125: </span><span style="color: #333333;">                       </span><span style="color: #FFA070;">in</span><span style="color: #333333;"> </span>pr'<span style="color: #333333;"> </span><span style="color: #A197BF;">++</span><span style="color: #333333;"> </span><span style="color: #868B44;">"1"</span><span style="color: #333333;"> </span><span style="color: #A197BF;">++</span><span style="color: #333333;"> </span>replicate<span style="color: #333333;"> </span>(l<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>pr'<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>1)<span style="color: #333333;"> </span><span style="color: #868B44;">'0'</span>
<span class="linenr">126: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">in</span><span style="color: #333333;"> </span>(c,nextWord)<span style="color: #EF5C5F;">:</span>xs
<span class="linenr">127: </span><span style="color: #333333;">    </span>table1<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>M.fromList<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>map<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>(c,s)<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>(c,(s,firstPass<span style="color: #333333;"> </span><span style="color: #A197BF;">M.!</span><span style="color: #333333;"> </span>c)))<span style="color: #333333;"> </span>codeWords
<span class="linenr">128: </span>
<span class="linenr">129: </span><span style="color: #8AAFFA;">runHuffman</span><span style="color: #333333;"> </span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">130: </span><span style="color: #333333;">    </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>((tbl1,<span style="color: #333333;"> </span>str),<span style="color: #333333;"> </span>tbl2)<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>runWriter<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>getLogger<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>huffman<span style="color: #333333;"> </span>x
<span class="linenr">131: </span><span style="color: #333333;">    </span>forM_<span style="color: #333333;"> </span>(M.assocs<span style="color: #333333;"> </span>tbl1)<span style="color: #333333;"> </span>print
<span class="linenr">132: </span><span style="color: #333333;">    </span>forM_<span style="color: #333333;"> </span>tbl2<span style="color: #333333;"> </span>print
<span class="linenr">133: </span>
<span class="linenr">134: </span>
<span class="linenr">135: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">136: </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">Adaptive</span><span style="color: #333333;"> </span><span style="color: #637579;">arithmetic</span><span style="color: #333333;"> </span><span style="color: #637579;">fixed</span><span style="color: #333333;"> </span><span style="color: #637579;">precision</span>
<span class="linenr">137: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">138: </span>
<span class="linenr">139: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithmState</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithmState</span>
<span class="linenr">140: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>_aLow<span style="color: #333333;">     </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Word16</span>
<span class="linenr">141: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>_aHigh<span style="color: #333333;">    </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Word16</span>
<span class="linenr">142: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>_aWord<span style="color: #333333;">    </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">143: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>_aLetters<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]
<span class="linenr">144: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>_aGLog<span style="color: #333333;">    </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Double</span>
<span class="linenr">145: </span><span style="color: #333333;">    </span>}<span style="color: #333333;"> </span><span style="color: #FFA070;">deriving</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span>
<span class="linenr">146: </span>
<span class="linenr">147: </span><span style="color: #8AAFFA;">makeLenses</span><span style="color: #333333;"> </span>''<span style="color: #EF5C5F;">ArithmState</span>
<span class="linenr">148: </span>
<span class="linenr">149: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithmTrace</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithmTrace</span>
<span class="linenr">150: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>aCurChar<span style="color: #333333;">   </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Char</span>]
<span class="linenr">151: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>aProb<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Rational</span>
<span class="linenr">152: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>aCodeWord<span style="color: #333333;">  </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">String</span>
<span class="linenr">153: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>aMsgLength<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">154: </span><span style="color: #333333;">    </span>}
<span class="linenr">155: </span>
<span class="linenr">156: </span><span style="color: #FFA070;">type</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithM</span><span style="color: #333333;"> </span>a<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">StateT</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithmState</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Writer</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">ArithmTrace</span>])<span style="color: #333333;"> </span>a
<span class="linenr">157: </span>
<span class="linenr">158: </span><span style="color: #FFA070;">instance</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithmTrace</span><span style="color: #333333;"> </span><span style="color: #FFA070;">where</span>
<span class="linenr">159: </span><span style="color: #333333;">    </span>show<span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithmTrace</span><span style="color: #333333;"> </span>{<span style="color: #A197BF;">..</span>}<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">160: </span><span style="color: #333333;">        </span>intercalate
<span class="linenr">161: </span><span style="color: #333333;">            </span><span style="color: #868B44;">"|"</span>
<span class="linenr">162: </span><span style="color: #333333;">            </span>[<span style="color: #868B44;">""</span>,<span style="color: #333333;"> </span>aCurChar,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>aProb,<span style="color: #333333;"> </span>aCodeWord,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>aMsgLength,<span style="color: #333333;"> </span><span style="color: #868B44;">""</span>]
<span class="linenr">163: </span>
<span class="linenr">164: </span><span style="color: #8AAFFA;">convertToBits</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Bits</span><span style="color: #333333;"> </span>a)<span style="color: #333333;"> </span><span style="color: #A197BF;">=&gt;</span><span style="color: #333333;"> </span>a<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">165: </span><span style="color: #8AAFFA;">convertToBits</span><span style="color: #333333;"> </span>x<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>reverse<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>map<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>testBit<span style="color: #333333;"> </span>x<span style="color: #333333;"> </span>i)<span style="color: #333333;"> </span>[0<span style="color: #333333;"> </span><span style="color: #A197BF;">..</span><span style="color: #333333;"> </span>i<span style="color: #A197BF;">-</span>1]
<span class="linenr">166: </span>
<span class="linenr">167: </span><span style="color: #8AAFFA;">arithmStep</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Map</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Word8</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Rational</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Word8</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithM</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">168: </span><span style="color: #8AAFFA;">arithmStep</span><span style="color: #333333;"> </span>prob<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">169: </span><span style="color: #333333;">    </span>low<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>use<span style="color: #333333;"> </span>aLow
<span class="linenr">170: </span><span style="color: #333333;">    </span>(delta<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Double</span>)<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>aHigh<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>low)
<span class="linenr">171: </span><span style="color: #333333;">    </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>member<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>M.member<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span>prob
<span class="linenr">172: </span><span style="color: #333333;">        </span>letter<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>bool<span style="color: #333333;"> </span>0xff<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span>member
<span class="linenr">173: </span><span style="color: #333333;">        </span>cast<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>fromRational<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>toRational
<span class="linenr">174: </span><span style="color: #333333;">        </span>p,<span style="color: #333333;"> </span>p'<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Word16</span>
<span class="linenr">175: </span><span style="color: #333333;">        </span>p<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>round<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">176: </span><span style="color: #333333;">            </span>delta<span style="color: #333333;"> </span><span style="color: #A197BF;">*</span>
<span class="linenr">177: </span><span style="color: #333333;">            </span>M.foldrWithKey
<span class="linenr">178: </span><span style="color: #333333;">                </span>(<span style="color: #A197BF;">\</span>w'<span style="color: #333333;"> </span>pr<span style="color: #333333;"> </span>acc<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>bool<span style="color: #333333;"> </span>acc<span style="color: #333333;"> </span>(acc<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>cast<span style="color: #333333;"> </span>pr)<span style="color: #333333;"> </span>(w'<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;</span><span style="color: #333333;"> </span>letter))
<span class="linenr">179: </span><span style="color: #333333;">                </span>0.0
<span class="linenr">180: </span><span style="color: #333333;">                </span>prob
<span class="linenr">181: </span><span style="color: #333333;">        </span>p'<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>p<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>round<span style="color: #333333;"> </span>(delta<span style="color: #333333;"> </span><span style="color: #A197BF;">*</span><span style="color: #333333;"> </span>cast<span style="color: #333333;"> </span>(prob<span style="color: #333333;"> </span><span style="color: #A197BF;">M.!</span><span style="color: #333333;"> </span>letter))
<span class="linenr">182: </span><span style="color: #333333;">        </span>matches<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">183: </span><span style="color: #333333;">            </span>maximum<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>0<span style="color: #333333;"> </span><span style="color: #EF5C5F;">:</span>
<span class="linenr">184: </span><span style="color: #333333;">            </span>filter
<span class="linenr">185: </span><span style="color: #333333;">                </span>(<span style="color: #A197BF;">\</span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>all<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>j<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>testBit<span style="color: #333333;"> </span>p<span style="color: #333333;"> </span>j<span style="color: #333333;"> </span><span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>testBit<span style="color: #333333;"> </span>p'<span style="color: #333333;"> </span>j)<span style="color: #333333;"> </span>[16<span style="color: #A197BF;">-</span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">..</span><span style="color: #333333;"> </span>15])
<span class="linenr">186: </span><span style="color: #333333;">                </span>[1<span style="color: #333333;"> </span><span style="color: #A197BF;">..</span><span style="color: #333333;"> </span>16]
<span class="linenr">187: </span><span style="color: #333333;">        </span>sameBits<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>take<span style="color: #333333;"> </span>matches<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>convertToBits<span style="color: #333333;"> </span>p<span style="color: #333333;"> </span>16
<span class="linenr">188: </span><span style="color: #333333;">        </span>low',<span style="color: #333333;"> </span>high'<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Word16</span>
<span class="linenr">189: </span><span style="color: #333333;">        </span>low'<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>shiftL<span style="color: #333333;"> </span>p<span style="color: #333333;"> </span>matches
<span class="linenr">190: </span><span style="color: #333333;">        </span>high'<span style="color: #333333;"> </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>matches<span style="color: #333333;"> </span><span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>0<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>p'
<span class="linenr">191: </span><span style="color: #333333;">              </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>otherwise<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>s<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>shiftL<span style="color: #333333;"> </span>p'<span style="color: #333333;"> </span>matches
<span class="linenr">192: </span><span style="color: #333333;">                            </span><span style="color: #FFA070;">in</span><span style="color: #333333;"> </span>s<span style="color: #333333;"> </span><span style="color: #A197BF;">.|.</span><span style="color: #333333;"> </span>(s<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>1)
<span class="linenr">193: </span><span style="color: #637579;">--</span><span style="color: #333333;">    </span><span style="color: #637579;">traceShowM</span><span style="color: #333333;"> </span><span style="color: #637579;">p</span>
<span class="linenr">194: </span><span style="color: #637579;">--</span><span style="color: #333333;">    </span><span style="color: #637579;">traceShowM</span><span style="color: #333333;"> </span><span style="color: #637579;">p'</span>
<span class="linenr">195: </span><span style="color: #637579;">--</span><span style="color: #333333;">    </span><span style="color: #637579;">traceShowM</span><span style="color: #333333;"> </span><span style="color: #637579;">sameBits</span>
<span class="linenr">196: </span><span style="color: #333333;">    </span>aLow<span style="color: #333333;"> </span><span style="color: #A197BF;">.=</span><span style="color: #333333;"> </span>low'
<span class="linenr">197: </span><span style="color: #333333;">    </span>aHigh<span style="color: #333333;"> </span><span style="color: #A197BF;">.=</span><span style="color: #333333;"> </span>high'
<span class="linenr">198: </span><span style="color: #333333;">    </span>aWord<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>sameBits
<span class="linenr">199: </span><span style="color: #333333;">    </span>when<span style="color: #333333;"> </span>member<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>aLetters<span style="color: #333333;"> </span><span style="color: #A197BF;">%=</span><span style="color: #333333;"> </span>(letter<span style="color: #EF5C5F;">:</span>)
<span class="linenr">200: </span><span style="color: #333333;">    </span>l<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>aWord<span style="color: #333333;"> </span>length
<span class="linenr">201: </span><span style="color: #333333;">    </span>aGLog<span style="color: #333333;"> </span><span style="color: #A197BF;">+=</span><span style="color: #333333;"> </span>(<span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>(log2<span style="color: #333333;"> </span>(cast<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>prob<span style="color: #333333;"> </span><span style="color: #A197BF;">M.!</span><span style="color: #333333;"> </span>letter)))
<span class="linenr">202: </span><span style="color: #333333;">    </span>tell<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">ArithmTrace</span><span style="color: #333333;"> </span>(chr'<span style="color: #333333;"> </span>letter)<span style="color: #333333;"> </span>(prob<span style="color: #333333;"> </span><span style="color: #A197BF;">M.!</span><span style="color: #333333;"> </span>letter)<span style="color: #333333;"> </span>(map<span style="color: #333333;"> </span>(bool<span style="color: #333333;"> </span><span style="color: #868B44;">'0'</span><span style="color: #333333;"> </span><span style="color: #868B44;">'1'</span>)<span style="color: #333333;"> </span>sameBits)<span style="color: #333333;"> </span>l]
<span class="linenr">203: </span>
<span class="linenr">204: </span><span style="color: #333333;">    </span>newLetters<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>aLetters<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span><span style="color: #A197BF;">\</span>letters<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>filter<span style="color: #333333;"> </span>(not<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>(<span style="color: #A197BF;">`elem`</span><span style="color: #333333;"> </span>letters))<span style="color: #333333;"> </span>[0<span style="color: #A197BF;">..</span>0xff]
<span class="linenr">205: </span><span style="color: #333333;">    </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>probWithEscape<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">206: </span><span style="color: #333333;">            </span>M.fromList<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>map<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>(i,<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">/</span><span style="color: #333333;"> </span>(fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>newLetters)))<span style="color: #333333;"> </span>newLetters
<span class="linenr">207: </span><span style="color: #333333;">    </span>when<span style="color: #333333;"> </span>(letter<span style="color: #333333;"> </span><span style="color: #A197BF;">/=</span><span style="color: #333333;"> </span>w)<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>arithmStep<span style="color: #333333;"> </span>probWithEscape<span style="color: #333333;"> </span>w
<span class="linenr">208: </span><span style="color: #333333;">  </span><span style="color: #FFA070;">where</span>
<span class="linenr">209: </span><span style="color: #333333;">    </span>chr'<span style="color: #333333;"> </span>0xff<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">"esc"</span>
<span class="linenr">210: </span><span style="color: #333333;">    </span>chr'<span style="color: #333333;"> </span>x<span style="color: #333333;">    </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>[chr<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span>x]
<span class="linenr">211: </span>
<span class="linenr">212: </span><span style="color: #8AAFFA;">finalizeArith</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithM</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">213: </span><span style="color: #8AAFFA;">finalizeArith</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">214: </span><span style="color: #333333;">    </span>high<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>aHigh<span style="color: #333333;"> </span>fromIntegral
<span class="linenr">215: </span><span style="color: #333333;">    </span>low<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>aLow<span style="color: #333333;"> </span>fromIntegral
<span class="linenr">216: </span><span style="color: #333333;">    </span>curL<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>aWord<span style="color: #333333;"> </span>length
<span class="linenr">217: </span><span style="color: #333333;">    </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>delta,<span style="color: #333333;"> </span>deltaP<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Double</span>
<span class="linenr">218: </span><span style="color: #333333;">        </span>delta<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>high<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>low
<span class="linenr">219: </span><span style="color: #333333;">        </span>deltaP<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>delta<span style="color: #333333;"> </span><span style="color: #A197BF;">/</span><span style="color: #333333;"> </span>0xffff
<span class="linenr">220: </span><span style="color: #333333;">    </span>bits<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>aGLog<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span><span style="color: #A197BF;">\</span>l<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span>
<span class="linenr">221: </span><span style="color: #333333;">        </span>take<span style="color: #333333;"> </span>(1<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>(ceiling<span style="color: #333333;"> </span>l)<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>curL)<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">222: </span><span style="color: #333333;">        </span>convertToBits<span style="color: #333333;"> </span><span style="color: #A197BF;">@</span><span style="color: #EF5C5F;">Word16</span><span style="color: #333333;"> </span>(round<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>low<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>delta<span style="color: #333333;"> </span><span style="color: #A197BF;">/</span><span style="color: #333333;"> </span>2)<span style="color: #333333;"> </span>16
<span class="linenr">223: </span><span style="color: #333333;">    </span>aWord<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>bits
<span class="linenr">224: </span><span style="color: #333333;">    </span>l<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>aWord<span style="color: #333333;"> </span>length
<span class="linenr">225: </span><span style="color: #333333;">    </span>tell<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">ArithmTrace</span><span style="color: #333333;"> </span><span style="color: #868B44;">"final"</span><span style="color: #333333;"> </span>0<span style="color: #333333;"> </span>(map<span style="color: #333333;"> </span>(bool<span style="color: #333333;"> </span><span style="color: #868B44;">'0'</span><span style="color: #333333;"> </span><span style="color: #868B44;">'1'</span>)<span style="color: #333333;"> </span>bits)<span style="color: #333333;"> </span>l]
<span class="linenr">226: </span>
<span class="linenr">227: </span><span style="color: #8AAFFA;">runAdaptiveArithm</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ArithM</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">228: </span><span style="color: #8AAFFA;">runAdaptiveArithm</span><span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">229: </span><span style="color: #333333;">    </span>forM_<span style="color: #333333;"> </span>[0<span style="color: #A197BF;">..</span>BS.length<span style="color: #333333;"> </span>input<span style="color: #A197BF;">-</span>1]<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span><span style="color: #A197BF;">\</span>k<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">230: </span><span style="color: #333333;">        </span>letters<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>use<span style="color: #333333;"> </span>aLetters
<span class="linenr">231: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>letters
<span class="linenr">232: </span><span style="color: #333333;">            </span>probM<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>M.fromList<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">233: </span><span style="color: #333333;">                </span>map<span style="color: #333333;"> </span>(second<span style="color: #333333;"> </span>(<span style="color: #A197BF;">/</span>(n<span style="color: #A197BF;">+</span>1)))<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">234: </span><span style="color: #333333;">                </span>(0xff,<span style="color: #333333;"> </span>1)<span style="color: #EF5C5F;">:</span>
<span class="linenr">235: </span><span style="color: #333333;">                </span>(map<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>l<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>(l,<span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>filter<span style="color: #333333;"> </span>(<span style="color: #A197BF;">==</span>l)<span style="color: #333333;"> </span>letters))<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>nub<span style="color: #333333;"> </span>letters)
<span class="linenr">236: </span><span style="color: #333333;">        </span>arithmStep<span style="color: #333333;"> </span>probM<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>BS.index<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span>k
<span class="linenr">237: </span><span style="color: #333333;">    </span>finalizeArith
<span class="linenr">238: </span>
<span class="linenr">239: </span><span style="color: #8AAFFA;">execAdaptiveArithm</span><span style="color: #333333;"> </span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">240: </span><span style="color: #333333;">    </span>runWriter<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>(runStateT<span style="color: #333333;"> </span>(runAdaptiveArithm<span style="color: #333333;"> </span>x)<span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">ArithmState</span><span style="color: #333333;"> </span>0<span style="color: #333333;"> </span>0xffff<span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span>0))
<span class="linenr">241: </span>
<span class="linenr">242: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">243: </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">Enumerative</span>
<span class="linenr">244: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">245: </span>
<span class="linenr">246: </span><span style="color: #8AAFFA;">factorial</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Integer</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Integer</span>
<span class="linenr">247: </span><span style="color: #8AAFFA;">factorial</span><span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>1
<span class="linenr">248: </span><span style="color: #8AAFFA;">factorial</span><span style="color: #333333;"> </span>0<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>1
<span class="linenr">249: </span><span style="color: #8AAFFA;">factorial</span><span style="color: #333333;"> </span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">*</span><span style="color: #333333;"> </span>factorial<span style="color: #333333;"> </span>(x<span style="color: #A197BF;">-</span>1)
<span class="linenr">250: </span>
<span class="linenr">251: </span><span style="color: #8AAFFA;">enumerative</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">BS.ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Integer</span>
<span class="linenr">252: </span><span style="color: #8AAFFA;">enumerative</span><span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>l1<span style="color: #A197BF;">+</span>l2
<span class="linenr">253: </span><span style="color: #333333;">  </span><span style="color: #FFA070;">where</span>
<span class="linenr">254: </span><span style="color: #333333;">    </span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>BS.length<span style="color: #333333;"> </span>input
<span class="linenr">255: </span><span style="color: #333333;">    </span>chars<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>BS.unpack<span style="color: #333333;"> </span>input
<span class="linenr">256: </span><span style="color: #333333;">    </span>unique<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>nub<span style="color: #333333;"> </span>chars
<span class="linenr">257: </span><span style="color: #333333;">    </span>occurences<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">258: </span><span style="color: #333333;">        </span>M.fromList<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">259: </span><span style="color: #333333;">        </span>map<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>(i,<span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>filter<span style="color: #333333;"> </span>(<span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>i)<span style="color: #333333;"> </span>chars))<span style="color: #333333;"> </span>unique
<span class="linenr">260: </span><span style="color: #333333;">    </span>comp,<span style="color: #333333;"> </span>compcomp,<span style="color: #333333;"> </span>comp'<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Integer</span>]
<span class="linenr">261: </span><span style="color: #333333;">    </span>comp<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>reverse<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">262: </span><span style="color: #333333;">           </span>sort<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>map<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>fromMaybe<span style="color: #333333;"> </span>0<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>M.lookup<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span>occurences)<span style="color: #333333;"> </span>[0<span style="color: #333333;"> </span><span style="color: #A197BF;">..</span><span style="color: #333333;"> </span>0xff]
<span class="linenr">263: </span><span style="color: #333333;">    </span>m<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>comp
<span class="linenr">264: </span><span style="color: #333333;">    </span>compcomp<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>map<span style="color: #333333;"> </span>(fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>length)<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>group<span style="color: #333333;"> </span>comp
<span class="linenr">265: </span><span style="color: #333333;">    </span>comp'<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>filter<span style="color: #333333;"> </span>(<span style="color: #A197BF;">&gt;</span><span style="color: #333333;"> </span>0)<span style="color: #333333;"> </span>comp
<span class="linenr">266: </span><span style="color: #333333;">    </span>l2<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>ceiling<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">267: </span><span style="color: #333333;">         </span>log2'<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>foldr<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>x<span style="color: #333333;"> </span>acc<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>acc<span style="color: #333333;"> </span><span style="color: #A197BF;">`div`</span><span style="color: #333333;"> </span>(factorial<span style="color: #333333;"> </span>x))<span style="color: #333333;"> </span>(factorial<span style="color: #333333;"> </span>n)<span style="color: #333333;"> </span>comp'
<span class="linenr">268: </span><span style="color: #333333;">    </span>l11<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>ceiling<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>log2'<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">*</span><span style="color: #333333;"> </span>product<span style="color: #333333;"> </span>comp'
<span class="linenr">269: </span><span style="color: #333333;">    </span>l12<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>ceiling<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">270: </span><span style="color: #333333;">          </span>log2'<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">271: </span><span style="color: #333333;">          </span>foldr<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>x<span style="color: #333333;"> </span>acc<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>acc<span style="color: #333333;"> </span><span style="color: #A197BF;">`div`</span><span style="color: #333333;"> </span>(factorial<span style="color: #333333;"> </span>x))
<span class="linenr">272: </span><span style="color: #333333;">                </span>(factorial<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>comp)
<span class="linenr">273: </span><span style="color: #333333;">                </span>compcomp
<span class="linenr">274: </span><span style="color: #333333;">    </span>l1<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>l11<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>l12
<span class="linenr">275: </span>
<span class="linenr">276: </span>
<span class="linenr">277: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">278: </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">Universal</span><span style="color: #333333;"> </span><span style="color: #637579;">coding</span>
<span class="linenr">279: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">280: </span>
<span class="linenr">281: </span><span style="color: #8AAFFA;">bin'</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">282: </span><span style="color: #8AAFFA;">bin'</span><span style="color: #333333;"> </span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>drop<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>dropWhile<span style="color: #333333;"> </span>not<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>convertToBits<span style="color: #333333;"> </span>x<span style="color: #333333;"> </span>32
<span class="linenr">283: </span>
<span class="linenr">284: </span><span style="color: #8AAFFA;">unar</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">285: </span><span style="color: #8AAFFA;">unar</span><span style="color: #333333;"> </span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>replicate<span style="color: #333333;"> </span>(n<span style="color: #A197BF;">-</span>1)<span style="color: #333333;"> </span><span style="color: #EF5C5F;">True</span><span style="color: #333333;"> </span><span style="color: #A197BF;">++</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">False</span>]
<span class="linenr">286: </span>
<span class="linenr">287: </span><span style="color: #8AAFFA;">elias</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">288: </span><span style="color: #8AAFFA;">elias</span><span style="color: #333333;"> </span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>p1<span style="color: #333333;"> </span><span style="color: #A197BF;">++</span><span style="color: #333333;"> </span>p2<span style="color: #333333;"> </span><span style="color: #A197BF;">++</span><span style="color: #333333;"> </span>p3
<span class="linenr">289: </span><span style="color: #333333;">  </span><span style="color: #FFA070;">where</span>
<span class="linenr">290: </span><span style="color: #333333;">    </span>p1<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>unar<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>2<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>p2
<span class="linenr">291: </span><span style="color: #333333;">    </span>p2<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>bin'<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>p3
<span class="linenr">292: </span><span style="color: #333333;">    </span>p3<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>bin'<span style="color: #333333;"> </span>n
<span class="linenr">293: </span>
<span class="linenr">294: </span><span style="color: #8AAFFA;">mon</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">295: </span><span style="color: #8AAFFA;">mon</span><span style="color: #333333;"> </span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>p1<span style="color: #333333;"> </span><span style="color: #A197BF;">++</span><span style="color: #333333;"> </span>p2
<span class="linenr">296: </span><span style="color: #333333;">  </span><span style="color: #FFA070;">where</span>
<span class="linenr">297: </span><span style="color: #333333;">    </span>p1<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>unar<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>p2<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>1
<span class="linenr">298: </span><span style="color: #333333;">    </span>p2<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>bin'<span style="color: #333333;"> </span>n
<span class="linenr">299: </span>
<span class="linenr">300: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">301: </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">LZ-77</span>
<span class="linenr">302: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">303: </span>
<span class="linenr">304: </span>
<span class="linenr">305: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77State</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77State</span>
<span class="linenr">306: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>_lzDict<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]
<span class="linenr">307: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>_lzWord<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">308: </span><span style="color: #333333;">    </span>}<span style="color: #333333;"> </span><span style="color: #FFA070;">deriving</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span>
<span class="linenr">309: </span>
<span class="linenr">310: </span><span style="color: #8AAFFA;">makeLenses</span><span style="color: #333333;"> </span>''<span style="color: #EF5C5F;">LZ77State</span>
<span class="linenr">311: </span>
<span class="linenr">312: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77Trace</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77Trace</span>
<span class="linenr">313: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>lzFlag<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Bool</span>
<span class="linenr">314: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzCurString<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">String</span>
<span class="linenr">315: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzDist<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Maybe</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">316: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzLength<span style="color: #333333;">    </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">317: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzCodeWord<span style="color: #333333;">  </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">318: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzBits<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">319: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzMsgLength<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">320: </span><span style="color: #333333;">    </span>}
<span class="linenr">321: </span>
<span class="linenr">322: </span><span style="color: #FFA070;">instance</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77Trace</span><span style="color: #333333;"> </span><span style="color: #FFA070;">where</span>
<span class="linenr">323: </span><span style="color: #333333;">    </span>show<span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77Trace</span><span style="color: #333333;"> </span>{<span style="color: #A197BF;">..</span>}<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">324: </span><span style="color: #333333;">        </span>intercalate
<span class="linenr">325: </span><span style="color: #333333;">            </span><span style="color: #868B44;">"|"</span>
<span class="linenr">326: </span><span style="color: #333333;">            </span>[<span style="color: #333333;"> </span><span style="color: #868B44;">""</span>
<span class="linenr">327: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>showBool<span style="color: #333333;"> </span>lzFlag
<span class="linenr">328: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>lzCurString
<span class="linenr">329: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>showMaybe<span style="color: #333333;"> </span>lzDist
<span class="linenr">330: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>lzLength
<span class="linenr">331: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>concatMap<span style="color: #333333;"> </span>showBool<span style="color: #333333;"> </span>lzCodeWord
<span class="linenr">332: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>lzBits
<span class="linenr">333: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>lzMsgLength
<span class="linenr">334: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span><span style="color: #868B44;">""</span>
<span class="linenr">335: </span><span style="color: #333333;">            </span>]
<span class="linenr">336: </span><span style="color: #333333;">      </span><span style="color: #FFA070;">where</span>
<span class="linenr">337: </span><span style="color: #333333;">        </span>showBool<span style="color: #333333;"> </span><span style="color: #EF5C5F;">False</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">"0"</span>
<span class="linenr">338: </span><span style="color: #333333;">        </span>showBool<span style="color: #333333;"> </span><span style="color: #EF5C5F;">True</span><span style="color: #333333;">  </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">"1"</span>
<span class="linenr">339: </span><span style="color: #333333;">        </span>showMaybe<span style="color: #333333;"> </span><span style="color: #EF5C5F;">Nothing</span><span style="color: #333333;">  </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">""</span>
<span class="linenr">340: </span><span style="color: #333333;">        </span>showMaybe<span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Just</span><span style="color: #333333;"> </span>a)<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>a
<span class="linenr">341: </span>
<span class="linenr">342: </span><span style="color: #FFA070;">type</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77M</span><span style="color: #333333;"> </span>a<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">StateT</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77State</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Writer</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">LZ77Trace</span>])<span style="color: #333333;"> </span>a
<span class="linenr">343: </span>
<span class="linenr">344: </span><span style="color: #8AAFFA;">lz77Do</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>])<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">BS.ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77M</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">345: </span><span style="color: #8AAFFA;">lz77Do</span><span style="color: #333333;"> </span>uni<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #FFA070;">_</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">&gt;=</span><span style="color: #333333;"> </span>BS.length<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>pure<span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">346: </span><span style="color: #8AAFFA;">lz77Do</span><span style="color: #333333;"> </span>uni<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span>window<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">347: </span><span style="color: #333333;">    </span>bestMatch<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>lzDict<span style="color: #333333;"> </span>workingInputs
<span class="linenr">348: </span><span style="color: #637579;">--</span><span style="color: #333333;">    </span><span style="color: #637579;">traceShowM</span><span style="color: #333333;"> </span><span style="color: #637579;">bestMatch</span>
<span class="linenr">349: </span><span style="color: #637579;">--</span><span style="color: #333333;">    </span><span style="color: #637579;">traceShowM</span><span style="color: #333333;"> </span><span style="color: #637579;">=&lt;&lt;</span><span style="color: #333333;"> </span><span style="color: #637579;">uses</span><span style="color: #333333;"> </span><span style="color: #637579;">lzDict</span><span style="color: #333333;"> </span><span style="color: #637579;">(map</span><span style="color: #333333;"> </span><span style="color: #637579;">(first</span><span style="color: #333333;"> </span><span style="color: #637579;">fromWord8)</span><span style="color: #333333;"> </span><span style="color: #637579;">.</span><span style="color: #333333;"> </span><span style="color: #637579;">subwords)</span>
<span class="linenr">350: </span><span style="color: #333333;">    </span>maybe<span style="color: #333333;"> </span>onNewWord<span style="color: #333333;"> </span>onMatch<span style="color: #333333;"> </span>bestMatch
<span class="linenr">351: </span><span style="color: #333333;">    </span>stripDictionary
<span class="linenr">352: </span><span style="color: #333333;">    </span>lz77Do<span style="color: #333333;"> </span>uni<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span>window<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>maybe<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>fst)<span style="color: #333333;"> </span>bestMatch
<span class="linenr">353: </span><span style="color: #333333;">  </span><span style="color: #FFA070;">where</span>
<span class="linenr">354: </span><span style="color: #333333;">    </span>onMatch<span style="color: #333333;"> </span>(match,i)<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">355: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>lzFlag<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">True</span>
<span class="linenr">356: </span><span style="color: #333333;">            </span>lzCurString<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>fromWord8<span style="color: #333333;"> </span>match
<span class="linenr">357: </span><span style="color: #333333;">            </span>lzLength<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>match
<span class="linenr">358: </span><span style="color: #333333;">        </span>lzDist<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>lzDict<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span><span style="color: #A197BF;">\</span>d<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>d<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>i
<span class="linenr">359: </span><span style="color: #333333;">        </span>dictSizeLog<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span>
<span class="linenr">360: </span><span style="color: #333333;">            </span>uses<span style="color: #333333;"> </span>lzDict<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>ceiling<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>log2'<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>(<span style="color: #A197BF;">+</span>1)<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>length
<span class="linenr">361: </span><span style="color: #637579;">--</span><span style="color: #333333;">        </span><span style="color: #637579;">traceShowM</span><span style="color: #333333;"> </span><span style="color: #637579;">lzCurString</span>
<span class="linenr">362: </span><span style="color: #637579;">--</span><span style="color: #333333;">        </span><span style="color: #637579;">traceShowM</span><span style="color: #333333;"> </span><span style="color: #637579;">=&lt;&lt;</span><span style="color: #333333;"> </span><span style="color: #637579;">uses</span><span style="color: #333333;"> </span><span style="color: #637579;">lzDict</span><span style="color: #333333;"> </span><span style="color: #637579;">length</span>
<span class="linenr">363: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>lzCodeWord<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">364: </span><span style="color: #333333;">                </span>lzFlag<span style="color: #333333;"> </span><span style="color: #EF5C5F;">:</span>
<span class="linenr">365: </span><span style="color: #333333;">                </span>convertToBits<span style="color: #333333;"> </span>lzDist<span style="color: #333333;"> </span>dictSizeLog<span style="color: #333333;"> </span><span style="color: #A197BF;">++</span>
<span class="linenr">366: </span><span style="color: #333333;">                </span>uni<span style="color: #333333;"> </span>lzLength
<span class="linenr">367: </span><span style="color: #333333;">            </span>lzBits<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>lzCodeWord
<span class="linenr">368: </span><span style="color: #333333;">        </span>lzWord<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>(lzCodeWord)
<span class="linenr">369: </span><span style="color: #333333;">        </span>lzMsgLength<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>lzWord<span style="color: #333333;"> </span>length
<span class="linenr">370: </span><span style="color: #333333;">        </span>tell<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">LZ77Trace</span><span style="color: #333333;"> </span>{lzDist<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Just</span><span style="color: #333333;"> </span>lzDist,<span style="color: #A197BF;">..</span>}]
<span class="linenr">371: </span><span style="color: #333333;">        </span>lzDict<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>match
<span class="linenr">372: </span><span style="color: #333333;">    </span>onNewWord<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">373: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>lzCodeWord<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>lzFlag<span style="color: #333333;"> </span><span style="color: #EF5C5F;">:</span><span style="color: #333333;"> </span>convertToBits<span style="color: #333333;"> </span>(fromJust<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>head<span style="color: #333333;"> </span>input')<span style="color: #333333;"> </span>8
<span class="linenr">374: </span><span style="color: #333333;">            </span>lzFlag<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">False</span>
<span class="linenr">375: </span><span style="color: #333333;">            </span>lzCurString<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">String</span>
<span class="linenr">376: </span><span style="color: #333333;">            </span>lzCurString<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>fromWord8<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>take<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span>input'
<span class="linenr">377: </span><span style="color: #333333;">            </span>lzDist<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Nothing</span>
<span class="linenr">378: </span><span style="color: #333333;">            </span>lzLength<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>0
<span class="linenr">379: </span><span style="color: #333333;">            </span>lzBits<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>lzCodeWord
<span class="linenr">380: </span><span style="color: #333333;">        </span>lzWord<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>lzCodeWord
<span class="linenr">381: </span><span style="color: #333333;">        </span>lzMsgLength<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>lzWord<span style="color: #333333;"> </span>length
<span class="linenr">382: </span><span style="color: #333333;">        </span>tell<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">LZ77Trace</span><span style="color: #333333;"> </span>{<span style="color: #A197BF;">..</span>}]
<span class="linenr">383: </span><span style="color: #333333;">        </span>lzDict<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>[fromJust<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>head<span style="color: #333333;"> </span>input']
<span class="linenr">384: </span><span style="color: #333333;">    </span>workingInputs<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Maybe</span><span style="color: #333333;"> </span>([<span style="color: #EF5C5F;">Word8</span>],<span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>)
<span class="linenr">385: </span><span style="color: #333333;">    </span>workingInputs<span style="color: #333333;"> </span>dict<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">386: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>filtered<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>filter<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>(pr,<span style="color: #333333;"> </span><span style="color: #FFA070;">_</span>)<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>pr<span style="color: #333333;"> </span><span style="color: #A197BF;">`isPrefixOf`</span><span style="color: #333333;"> </span>input')<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">387: </span><span style="color: #333333;">                </span>subwords<span style="color: #333333;"> </span>dict
<span class="linenr">388: </span><span style="color: #333333;">        </span><span style="color: #FFA070;">in</span><span style="color: #333333;"> </span>bool<span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Just</span><span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>maximumBy<span style="color: #333333;"> </span>(comparing<span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>fst))<span style="color: #333333;"> </span>filtered)
<span class="linenr">389: </span><span style="color: #333333;">                </span><span style="color: #EF5C5F;">Nothing</span>
<span class="linenr">390: </span><span style="color: #333333;">                </span>(null<span style="color: #333333;"> </span>filtered)
<span class="linenr">391: </span><span style="color: #333333;">    </span>stripDictionary<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">392: </span><span style="color: #333333;">        </span>l<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>lzDict<span style="color: #333333;"> </span>length
<span class="linenr">393: </span><span style="color: #333333;">        </span>when<span style="color: #333333;"> </span>(l<span style="color: #333333;"> </span><span style="color: #A197BF;">&gt;</span><span style="color: #333333;"> </span>window)<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>lzDict<span style="color: #333333;"> </span><span style="color: #A197BF;">%=</span><span style="color: #333333;"> </span>drop<span style="color: #333333;"> </span>(l<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>window)
<span class="linenr">394: </span><span style="color: #333333;">    </span>input'<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>BS.unpack<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>BS.drop<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span>input
<span class="linenr">395: </span><span style="color: #333333;">    </span>tails'<span style="color: #333333;"> </span>xs<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>dropEnd<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span>(tails<span style="color: #333333;"> </span>xs)<span style="color: #333333;"> </span><span style="color: #A197BF;">`zip`</span><span style="color: #333333;"> </span>[0<span style="color: #333333;"> </span><span style="color: #A197BF;">..</span>]
<span class="linenr">396: </span><span style="color: #333333;">    </span>inits'<span style="color: #333333;"> </span>xs<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>concatMap<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>(str,<span style="color: #333333;"> </span>i)<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>drop<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>(,i)<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;$&gt;</span><span style="color: #333333;"> </span>inits<span style="color: #333333;"> </span>str)<span style="color: #333333;"> </span>xs
<span class="linenr">397: </span><span style="color: #333333;">    </span>subwords<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[a]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[([a],<span style="color: #EF5C5F;">Int</span>)]
<span class="linenr">398: </span><span style="color: #333333;">    </span>subwords<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>reverse<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>inits'<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>tails'
<span class="linenr">399: </span>
<span class="linenr">400: </span><span style="color: #8AAFFA;">lz77Encode</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>])<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">BS.ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77M</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">401: </span><span style="color: #8AAFFA;">lz77Encode</span><span style="color: #333333;"> </span>uni<span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>lz77Do<span style="color: #333333;"> </span>uni<span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span>0
<span class="linenr">402: </span>
<span class="linenr">403: </span><span style="color: #8AAFFA;">execLz77</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>])<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>((<span style="color: #EF5C5F;">()</span>,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">LZ77State</span>),<span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">LZ77Trace</span>])
<span class="linenr">404: </span><span style="color: #8AAFFA;">execLz77</span><span style="color: #333333;"> </span>u<span style="color: #333333;"> </span>x<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>runWriter<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>(runStateT<span style="color: #333333;"> </span>(lz77Encode<span style="color: #333333;"> </span>u<span style="color: #333333;"> </span>x<span style="color: #333333;"> </span>w)<span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">LZ77State</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span>))
<span class="linenr">405: </span>
<span class="linenr">406: </span><span style="color: #8AAFFA;">lz77Other</span><span style="color: #333333;"> </span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>map<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>(u,w)<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>(toUniS<span style="color: #333333;"> </span>u,<span style="color: #333333;"> </span>w,<span style="color: #333333;"> </span>exec<span style="color: #333333;"> </span>(toUni<span style="color: #333333;"> </span>u)<span style="color: #333333;"> </span>w))<span style="color: #333333;"> </span>testData
<span class="linenr">407: </span><span style="color: #333333;">  </span><span style="color: #FFA070;">where</span>
<span class="linenr">408: </span><span style="color: #333333;">    </span>toUni<span style="color: #333333;"> </span>0<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>unar
<span class="linenr">409: </span><span style="color: #333333;">    </span>toUni<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>mon
<span class="linenr">410: </span><span style="color: #333333;">    </span>toUni<span style="color: #333333;"> </span>2<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>elias
<span class="linenr">411: </span><span style="color: #333333;">    </span>toUniS<span style="color: #333333;"> </span>0<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">"Unary"</span>
<span class="linenr">412: </span><span style="color: #333333;">    </span>toUniS<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">"Levenshtein"</span>
<span class="linenr">413: </span><span style="color: #333333;">    </span>toUniS<span style="color: #333333;"> </span>2<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">"Elias"</span>
<span class="linenr">414: </span><span style="color: #333333;">    </span>testData<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>[(uni,<span style="color: #333333;"> </span>w)<span style="color: #333333;"> </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>uni<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>[0<span style="color: #A197BF;">..</span>2],<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>[50,100,200,500,1000,2000,4000]]
<span class="linenr">415: </span><span style="color: #333333;">    </span>exec<span style="color: #333333;"> </span>uni<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>(execLz77<span style="color: #333333;"> </span>uni<span style="color: #333333;"> </span>x<span style="color: #333333;"> </span>w)<span style="color: #333333;"> </span><span style="color: #A197BF;">^.</span><span style="color: #333333;"> </span>_1<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>_2<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>lzWord<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>to<span style="color: #333333;"> </span>length
<span class="linenr">416: </span>
<span class="linenr">417: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">418: </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">LZ78</span><span style="color: #333333;"> </span><span style="color: #637579;">(LZW)</span>
<span class="linenr">419: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">420: </span>
<span class="linenr">421: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwState</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwState</span>
<span class="linenr">422: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>_lzwDict<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[[<span style="color: #EF5C5F;">Word8</span>]]
<span class="linenr">423: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>_lzwWord<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">424: </span><span style="color: #333333;">    </span>}<span style="color: #333333;"> </span><span style="color: #FFA070;">deriving</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span>
<span class="linenr">425: </span>
<span class="linenr">426: </span><span style="color: #8AAFFA;">makeLenses</span><span style="color: #333333;"> </span>''<span style="color: #EF5C5F;">LzwState</span>
<span class="linenr">427: </span>
<span class="linenr">428: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwTrace</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwTrace</span>
<span class="linenr">429: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>lzwNewWord<span style="color: #333333;">   </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Maybe</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">String</span>
<span class="linenr">430: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzwMatch<span style="color: #333333;">     </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">String</span>
<span class="linenr">431: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzwWordId<span style="color: #333333;">    </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">432: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzwCodeWord<span style="color: #333333;">  </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">433: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzwBits<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">434: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>lzwMsgLength<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">435: </span><span style="color: #333333;">    </span>}
<span class="linenr">436: </span>
<span class="linenr">437: </span><span style="color: #FFA070;">instance</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwTrace</span><span style="color: #333333;"> </span><span style="color: #FFA070;">where</span>
<span class="linenr">438: </span><span style="color: #333333;">    </span>show<span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwTrace</span><span style="color: #333333;"> </span>{<span style="color: #A197BF;">..</span>}<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">439: </span><span style="color: #333333;">        </span>intercalate
<span class="linenr">440: </span><span style="color: #333333;">            </span><span style="color: #868B44;">"|"</span>
<span class="linenr">441: </span><span style="color: #333333;">            </span>[<span style="color: #333333;"> </span><span style="color: #868B44;">""</span>
<span class="linenr">442: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>fromMaybe<span style="color: #333333;"> </span><span style="color: #868B44;">""</span><span style="color: #333333;"> </span>lzwNewWord
<span class="linenr">443: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>lzwMatch
<span class="linenr">444: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>lzwWordId
<span class="linenr">445: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>concatMap<span style="color: #333333;"> </span>showBool<span style="color: #333333;"> </span>lzwCodeWord
<span class="linenr">446: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>lzwBits
<span class="linenr">447: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>lzwMsgLength
<span class="linenr">448: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span><span style="color: #868B44;">""</span>
<span class="linenr">449: </span><span style="color: #333333;">            </span>]
<span class="linenr">450: </span><span style="color: #333333;">      </span><span style="color: #FFA070;">where</span>
<span class="linenr">451: </span><span style="color: #333333;">        </span>showBool<span style="color: #333333;"> </span><span style="color: #EF5C5F;">False</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">"0"</span>
<span class="linenr">452: </span><span style="color: #333333;">        </span>showBool<span style="color: #333333;"> </span><span style="color: #EF5C5F;">True</span><span style="color: #333333;">  </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">"1"</span>
<span class="linenr">453: </span>
<span class="linenr">454: </span><span style="color: #FFA070;">type</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwM</span><span style="color: #333333;"> </span>a<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">StateT</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwState</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Writer</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">LzwTrace</span>])<span style="color: #333333;"> </span>a
<span class="linenr">455: </span>
<span class="linenr">456: </span>
<span class="linenr">457: </span><span style="color: #8AAFFA;">lzwDo</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">BS.ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwM</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">458: </span><span style="color: #8AAFFA;">lzwDo</span><span style="color: #333333;"> </span>input<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">&gt;=</span><span style="color: #333333;"> </span>BS.length<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>pure<span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">459: </span><span style="color: #8AAFFA;">lzwDo</span><span style="color: #333333;"> </span>input<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">460: </span><span style="color: #333333;">    </span>matchIndex<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>lzwDict<span style="color: #333333;"> </span>workingInputs
<span class="linenr">461: </span><span style="color: #333333;">    </span>(match<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>])<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>lzwDict<span style="color: #333333;"> </span>(<span style="color: #A197BF;">!!</span><span style="color: #333333;"> </span>matchIndex)
<span class="linenr">462: </span><span style="color: #333333;">    </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>matchLen<span style="color: #333333;"> </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>match<span style="color: #333333;"> </span><span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>[92]<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>0
<span class="linenr">463: </span><span style="color: #333333;">                 </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>otherwise<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>match
<span class="linenr">464: </span><span style="color: #333333;">    </span>dictSizeLog<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span>
<span class="linenr">465: </span><span style="color: #333333;">        </span>uses<span style="color: #333333;"> </span>lzwDict<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>ceiling<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>log2'<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>pred<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>length
<span class="linenr">466: </span><span style="color: #333333;">    </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>lzwCodeWord<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>convertToBits<span style="color: #333333;"> </span>matchIndex<span style="color: #333333;"> </span>dictSizeLog<span style="color: #333333;"> </span><span style="color: #A197BF;">++</span>
<span class="linenr">467: </span><span style="color: #333333;">            </span>(<span style="color: #FFA070;">if</span><span style="color: #333333;"> </span>matchIndex<span style="color: #333333;"> </span><span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>0
<span class="linenr">468: </span><span style="color: #333333;">             </span><span style="color: #FFA070;">then</span><span style="color: #333333;"> </span>convertToBits<span style="color: #333333;"> </span>(fromJust<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>head<span style="color: #333333;"> </span>input')<span style="color: #333333;"> </span>8
<span class="linenr">469: </span><span style="color: #333333;">             </span><span style="color: #FFA070;">else</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span>)
<span class="linenr">470: </span><span style="color: #333333;">        </span>lzwBits<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>lzwCodeWord
<span class="linenr">471: </span><span style="color: #333333;">    </span>lzwWord<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>lzwCodeWord
<span class="linenr">472: </span><span style="color: #333333;">    </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>newWord<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>take<span style="color: #333333;"> </span>(matchLen<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>1)<span style="color: #333333;"> </span>input'
<span class="linenr">473: </span><span style="color: #333333;">                  </span><span style="color: #FFA070;">in</span><span style="color: #333333;"> </span>bool<span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Just</span><span style="color: #333333;"> </span>w)<span style="color: #333333;"> </span><span style="color: #EF5C5F;">Nothing</span><span style="color: #333333;"> </span>(w<span style="color: #333333;"> </span><span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>match)
<span class="linenr">474: </span><span style="color: #333333;">        </span>lzwNewWord<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>fromWord8<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;$&gt;</span><span style="color: #333333;"> </span>newWord
<span class="linenr">475: </span><span style="color: #333333;">        </span>lzwWordId<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>matchIndex
<span class="linenr">476: </span><span style="color: #333333;">        </span>lzwMatch<span style="color: #333333;"> </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>match<span style="color: #333333;"> </span><span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>[92]<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">""</span>
<span class="linenr">477: </span><span style="color: #333333;">                 </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>otherwise<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>fromWord8<span style="color: #333333;"> </span>match
<span class="linenr">478: </span><span style="color: #333333;">    </span>lzwMsgLength<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>lzwWord<span style="color: #333333;"> </span>length
<span class="linenr">479: </span><span style="color: #333333;">    </span>whenJust<span style="color: #333333;"> </span>newWord<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span><span style="color: #A197BF;">\</span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>lzwDict<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>[w]
<span class="linenr">480: </span><span style="color: #333333;">    </span>tell<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">LzwTrace</span>{<span style="color: #A197BF;">..</span>}]
<span class="linenr">481: </span><span style="color: #333333;">    </span>lzwDo<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>(bool<span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span>match)<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>matchIndex<span style="color: #333333;"> </span><span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>0)
<span class="linenr">482: </span><span style="color: #333333;">  </span><span style="color: #FFA070;">where</span>
<span class="linenr">483: </span><span style="color: #333333;">    </span>workingInputs<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[[<span style="color: #EF5C5F;">Word8</span>]]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">484: </span><span style="color: #333333;">    </span>workingInputs<span style="color: #333333;"> </span>dict<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">485: </span><span style="color: #333333;">        </span>fromMaybe<span style="color: #333333;"> </span>0<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">486: </span><span style="color: #333333;">        </span>getLast<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">487: </span><span style="color: #333333;">        </span>mconcat<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">488: </span><span style="color: #333333;">        </span>map<span style="color: #333333;"> </span><span style="color: #EF5C5F;">Last</span><span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">489: </span><span style="color: #333333;">        </span>map<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>findIndex<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">&amp;&amp;</span><span style="color: #333333;"> </span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">`isPrefixOf`</span><span style="color: #333333;"> </span>input')<span style="color: #333333;"> </span>dict)
<span class="linenr">490: </span><span style="color: #333333;">            </span>[0<span style="color: #A197BF;">..</span>length<span style="color: #333333;"> </span>dict<span style="color: #A197BF;">-</span>1]
<span class="linenr">491: </span><span style="color: #333333;">    </span>input'<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>BS.unpack<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>BS.drop<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span>input
<span class="linenr">492: </span>
<span class="linenr">493: </span><span style="color: #8AAFFA;">lzwEncode</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">BS.ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwM</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">494: </span><span style="color: #8AAFFA;">lzwEncode</span><span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>lzwDo<span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span>0
<span class="linenr">495: </span>
<span class="linenr">496: </span><span style="color: #8AAFFA;">execLzw</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>((<span style="color: #EF5C5F;">()</span>,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">LzwState</span>),<span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">LzwTrace</span>])
<span class="linenr">497: </span><span style="color: #8AAFFA;">execLzw</span><span style="color: #333333;"> </span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>runWriter<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>(runStateT<span style="color: #333333;"> </span>(lzwEncode<span style="color: #333333;"> </span>x)<span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">LzwState</span><span style="color: #333333;"> </span>[BS.unpack<span style="color: #333333;"> </span><span style="color: #868B44;">"\\"</span>]<span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span>))
<span class="linenr">498: </span>
<span class="linenr">499: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">500: </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">PPMA</span>
<span class="linenr">501: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">502: </span>
<span class="linenr">503: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">PpmState</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">PpmState</span>
<span class="linenr">504: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>_pLetters<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]
<span class="linenr">505: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>_pGLog<span style="color: #333333;">    </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Double</span>
<span class="linenr">506: </span><span style="color: #333333;">    </span>}<span style="color: #333333;"> </span><span style="color: #FFA070;">deriving</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span>
<span class="linenr">507: </span>
<span class="linenr">508: </span><span style="color: #8AAFFA;">makeLenses</span><span style="color: #333333;"> </span>''<span style="color: #EF5C5F;">PpmState</span>
<span class="linenr">509: </span>
<span class="linenr">510: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">PpmTrace</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">PpmTrace</span>
<span class="linenr">511: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>pCurChar<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Char</span>
<span class="linenr">512: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>pContextTimes<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Int</span>]
<span class="linenr">513: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>pContext<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Char</span>]
<span class="linenr">514: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>pEscProbs<span style="color: #333333;">     </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Ratio</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>]
<span class="linenr">515: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>pCharProb<span style="color: #333333;">     </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Ratio</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">516: </span><span style="color: #333333;">    </span>}
<span class="linenr">517: </span>
<span class="linenr">518: </span><span style="color: #FFA070;">type</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">PpmM</span><span style="color: #333333;"> </span>a<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">StateT</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">PpmState</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Writer</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">PpmTrace</span>])<span style="color: #333333;"> </span>a
<span class="linenr">519: </span>
<span class="linenr">520: </span><span style="color: #FFA070;">instance</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">PpmTrace</span><span style="color: #333333;"> </span><span style="color: #FFA070;">where</span>
<span class="linenr">521: </span><span style="color: #333333;">    </span>show<span style="color: #333333;"> </span><span style="color: #EF5C5F;">PpmTrace</span><span style="color: #333333;"> </span>{<span style="color: #A197BF;">..</span>}<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">522: </span><span style="color: #333333;">        </span>intercalate
<span class="linenr">523: </span><span style="color: #333333;">            </span><span style="color: #868B44;">"|"</span>
<span class="linenr">524: </span><span style="color: #333333;">            </span>[<span style="color: #333333;"> </span><span style="color: #868B44;">""</span>
<span class="linenr">525: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>[pCurChar]
<span class="linenr">526: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>bool<span style="color: #333333;"> </span>(show<span style="color: #333333;"> </span>pContext)<span style="color: #333333;"> </span><span style="color: #868B44;">"#"</span><span style="color: #333333;"> </span>(null<span style="color: #333333;"> </span>pContext)
<span class="linenr">527: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>intercalate<span style="color: #333333;"> </span><span style="color: #868B44;">","</span><span style="color: #333333;"> </span>(map<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>pContextTimes)
<span class="linenr">528: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>intercalate<span style="color: #333333;"> </span><span style="color: #868B44;">","</span><span style="color: #333333;"> </span>(map<span style="color: #333333;"> </span>showRat<span style="color: #333333;"> </span>pEscProbs)
<span class="linenr">529: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>showRat<span style="color: #333333;"> </span>pCharProb
<span class="linenr">530: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span><span style="color: #868B44;">""</span>
<span class="linenr">531: </span><span style="color: #333333;">            </span>]
<span class="linenr">532: </span><span style="color: #333333;">      </span><span style="color: #FFA070;">where</span><span style="color: #333333;"> </span>showRat<span style="color: #333333;"> </span>r<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>(numerator<span style="color: #333333;"> </span>r)<span style="color: #333333;"> </span><span style="color: #A197BF;">++</span><span style="color: #333333;"> </span><span style="color: #868B44;">"/"</span><span style="color: #333333;"> </span><span style="color: #A197BF;">++</span><span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>(denominator<span style="color: #333333;"> </span>r)
<span class="linenr">533: </span>
<span class="linenr">534: </span><span style="color: #8AAFFA;">ppmCalculate</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">PpmM</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">535: </span><span style="color: #8AAFFA;">ppmCalculate</span><span style="color: #333333;"> </span><span style="color: #FFA070;">_</span><span style="color: #333333;"> </span>input<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">&gt;=</span><span style="color: #333333;"> </span>BS.length<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>pure<span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">536: </span><span style="color: #8AAFFA;">ppmCalculate</span><span style="color: #333333;"> </span>d<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">537: </span><span style="color: #333333;">    </span>history<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>use<span style="color: #333333;"> </span>pLetters
<span class="linenr">538: </span><span style="color: #333333;">    </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>c<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>BS.index<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span>i
<span class="linenr">539: </span><span style="color: #333333;">        </span>maxD<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>min<span style="color: #333333;"> </span>d<span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span>history<span style="color: #333333;"> </span><span style="color: #A197BF;">`div`</span><span style="color: #333333;"> </span>2)
<span class="linenr">540: </span><span style="color: #333333;">        </span>startContext<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]
<span class="linenr">541: </span><span style="color: #333333;">        </span>startContext<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">542: </span><span style="color: #333333;">            </span>fromMaybe<span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>head<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">543: </span><span style="color: #333333;">            </span>mapMaybe<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>d'<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>dropEnd<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>view<span style="color: #333333;"> </span>_2<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;$&gt;</span>
<span class="linenr">544: </span><span style="color: #333333;">                             </span>head<span style="color: #333333;"> </span>(findSubstring<span style="color: #333333;"> </span>history<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>takeEnd<span style="color: #333333;"> </span>d'<span style="color: #333333;"> </span>history))<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">545: </span><span style="color: #333333;">            </span>reverse<span style="color: #333333;"> </span>[0<span style="color: #A197BF;">..</span>maxD]
<span class="linenr">546: </span><span style="color: #333333;">        </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">Input:</span><span style="color: #333333;"> </span><span style="color: #637579;">exceptions</span><span style="color: #333333;"> </span><span style="color: #637579;">list</span><span style="color: #333333;"> </span><span style="color: #637579;">(match</span><span style="color: #333333;"> </span><span style="color: #637579;">&lt;&gt;</span><span style="color: #333333;"> </span><span style="color: #637579;">c),</span><span style="color: #333333;"> </span><span style="color: #637579;">string</span><span style="color: #333333;"> </span><span style="color: #637579;">s</span>
<span class="linenr">547: </span><span style="color: #333333;">        </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">Output:</span><span style="color: #333333;"> </span><span style="color: #637579;">probability</span><span style="color: #333333;"> </span><span style="color: #637579;">p_t(a|s),</span><span style="color: #333333;"> </span><span style="color: #637579;">new</span><span style="color: #333333;"> </span><span style="color: #637579;">exceptions</span>
<span class="linenr">548: </span><span style="color: #333333;">        </span>calcProb<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[[<span style="color: #EF5C5F;">Word8</span>]]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Ratio</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>,<span style="color: #333333;"> </span>[[<span style="color: #EF5C5F;">Word8</span>]])
<span class="linenr">549: </span><span style="color: #333333;">        </span>calcProb<span style="color: #333333;"> </span>exs<span style="color: #333333;"> </span>s<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">550: </span><span style="color: #333333;">            </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>&#964;<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>filter<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>(<span style="color: #FFA070;">_</span>,match,<span style="color: #FFA070;">_</span>)<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>not<span style="color: #333333;"> </span>(match<span style="color: #333333;"> </span><span style="color: #A197BF;">`elem`</span><span style="color: #333333;"> </span>exs))<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">551: </span><span style="color: #333333;">                    </span>findSubstring<span style="color: #333333;"> </span>(dropEnd<span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span>s)<span style="color: #333333;"> </span>history)<span style="color: #333333;"> </span>s
<span class="linenr">552: </span><span style="color: #333333;">                </span>&#964;sa<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>filter<span style="color: #333333;"> </span>((<span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>c)<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>view<span style="color: #333333;"> </span>_3)<span style="color: #333333;"> </span>&#964;
<span class="linenr">553: </span><span style="color: #333333;">            </span><span style="color: #FFA070;">in</span><span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span>&#964;sa<span style="color: #333333;"> </span><span style="color: #A197BF;">%</span><span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span>&#964;<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>1),
<span class="linenr">554: </span><span style="color: #333333;">               </span>concatMap<span style="color: #333333;"> </span>(tails<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>view<span style="color: #333333;"> </span>_2)<span style="color: #333333;"> </span>&#964;)
<span class="linenr">555: </span><span style="color: #333333;">        </span>calcEscProb<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[[<span style="color: #EF5C5F;">Word8</span>]]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Ratio</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">556: </span><span style="color: #333333;">        </span>calcEscProb<span style="color: #333333;"> </span>exs<span style="color: #333333;"> </span>s<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">557: </span><span style="color: #333333;">            </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>&#964;<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>filter<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>(<span style="color: #FFA070;">_</span>,match,<span style="color: #FFA070;">_</span>)<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>not<span style="color: #333333;"> </span>(match<span style="color: #333333;"> </span><span style="color: #A197BF;">`elem`</span><span style="color: #333333;"> </span>exs))<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">558: </span><span style="color: #333333;">                    </span>findSubstring<span style="color: #333333;"> </span>(dropEnd<span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span>s)<span style="color: #333333;"> </span>history)<span style="color: #333333;"> </span>s
<span class="linenr">559: </span><span style="color: #333333;">            </span><span style="color: #FFA070;">in</span><span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">%</span><span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span>&#964;<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>1)
<span class="linenr">560: </span><span style="color: #333333;">        </span>encodeEscapes<span style="color: #333333;"> </span>probs<span style="color: #333333;"> </span>ms<span style="color: #333333;"> </span>exs<span style="color: #333333;"> </span>s<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">561: </span><span style="color: #333333;">            </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>(prob,<span style="color: #333333;"> </span>nextExc)<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>calcProb<span style="color: #333333;"> </span>exs<span style="color: #333333;"> </span>s
<span class="linenr">562: </span><span style="color: #333333;">                </span>matchN<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>findSubstring<span style="color: #333333;"> </span>history<span style="color: #333333;"> </span>s
<span class="linenr">563: </span><span style="color: #333333;">                </span>probEsc<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>calcEscProb<span style="color: #333333;"> </span>exs<span style="color: #333333;"> </span>s
<span class="linenr">564: </span><span style="color: #333333;">                </span>probs'<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>probEsc<span style="color: #EF5C5F;">:</span>probs
<span class="linenr">565: </span><span style="color: #333333;">                </span>ms'<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>matchN<span style="color: #EF5C5F;">:</span>ms
<span class="linenr">566: </span><span style="color: #333333;">                </span>nonMetProb<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">%</span><span style="color: #333333;"> </span>(256<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>nub<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>history))
<span class="linenr">567: </span><span style="color: #333333;">            </span><span style="color: #FFA070;">if</span><span style="color: #333333;"> </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>prob<span style="color: #333333;"> </span><span style="color: #A197BF;">/=</span><span style="color: #333333;"> </span>0<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>(probs,ms',prob)
<span class="linenr">568: </span><span style="color: #333333;">               </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>s<span style="color: #333333;"> </span><span style="color: #A197BF;">&gt;</span><span style="color: #333333;"> </span>0<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>encodeEscapes<span style="color: #333333;"> </span>probs'<span style="color: #333333;"> </span>ms'<span style="color: #333333;"> </span>(nub<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>exs<span style="color: #A197BF;">++</span>nextExc)<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>drop<span style="color: #333333;"> </span>1<span style="color: #333333;"> </span>s
<span class="linenr">569: </span><span style="color: #333333;">               </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>otherwise<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>(probs',ms',nonMetProb)
<span class="linenr">570: </span><span style="color: #333333;">        </span>r<span style="color: #A197BF;">@</span>(probs,matchNs,prob)<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>encodeEscapes<span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span>startContext
<span class="linenr">571: </span><span style="color: #637579;">--</span><span style="color: #333333;">    </span><span style="color: #637579;">traceM</span><span style="color: #333333;"> </span><span style="color: #637579;">$</span><span style="color: #333333;"> </span><span style="color: #637579;">"MaxD:</span><span style="color: #333333;"> </span><span style="color: #637579;">"</span><span style="color: #333333;"> </span><span style="color: #637579;">&lt;&gt;</span><span style="color: #333333;"> </span><span style="color: #637579;">show</span><span style="color: #333333;"> </span><span style="color: #637579;">maxD</span>
<span class="linenr">572: </span><span style="color: #637579;">--</span><span style="color: #333333;">    </span><span style="color: #637579;">traceM</span><span style="color: #333333;"> </span><span style="color: #637579;">$</span><span style="color: #333333;"> </span><span style="color: #637579;">"Start</span><span style="color: #333333;"> </span><span style="color: #637579;">context:</span><span style="color: #333333;"> </span><span style="color: #637579;">"</span><span style="color: #333333;"> </span><span style="color: #637579;">&lt;&gt;</span><span style="color: #333333;"> </span><span style="color: #637579;">show</span><span style="color: #333333;"> </span><span style="color: #637579;">(fromWord8</span><span style="color: #333333;"> </span><span style="color: #637579;">startContext)</span>
<span class="linenr">573: </span><span style="color: #637579;">--</span><span style="color: #333333;">    </span><span style="color: #637579;">traceShowM</span><span style="color: #333333;"> </span><span style="color: #637579;">r</span>
<span class="linenr">574: </span><span style="color: #333333;">    </span>tell<span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">PpmTrace</span><span style="color: #333333;"> </span>(chr<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span>c)
<span class="linenr">575: </span><span style="color: #333333;">                   </span>(reverse<span style="color: #333333;"> </span>matchNs)
<span class="linenr">576: </span><span style="color: #333333;">                   </span>(fromWord8<span style="color: #333333;"> </span>startContext)
<span class="linenr">577: </span><span style="color: #333333;">                   </span>(reverse<span style="color: #333333;"> </span>probs)
<span class="linenr">578: </span><span style="color: #333333;">                   </span>prob]
<span class="linenr">579: </span><span style="color: #333333;">    </span>pLetters<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>[c]
<span class="linenr">580: </span><span style="color: #333333;">    </span>pGLog<span style="color: #333333;"> </span><span style="color: #A197BF;">+=</span><span style="color: #333333;"> </span>(<span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>(log2<span style="color: #333333;"> </span>(fromRational<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>toRational<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>product<span style="color: #333333;"> </span>probs<span style="color: #333333;"> </span><span style="color: #A197BF;">*</span><span style="color: #333333;"> </span>prob)))
<span class="linenr">581: </span><span style="color: #333333;">    </span>ppmCalculate<span style="color: #333333;"> </span>d<span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>1
<span class="linenr">582: </span>
<span class="linenr">583: </span><span style="color: #868B44;">--</span><span style="color: #333333;"> </span><span style="color: #868B44;">|</span><span style="color: #333333;"> </span><span style="color: #868B44;">For</span><span style="color: #333333;"> </span><span style="color: #868B44;">a</span><span style="color: #333333;"> </span><span style="color: #868B44;">text</span><span style="color: #333333;"> </span><span style="color: #868B44;">and</span><span style="color: #333333;"> </span><span style="color: #868B44;">pattern</span><span style="color: #333333;"> </span><span style="color: #868B44;">it</span><span style="color: #333333;"> </span><span style="color: #868B44;">returns</span><span style="color: #333333;"> </span><span style="color: #868B44;">the</span><span style="color: #333333;"> </span><span style="color: #868B44;">list</span><span style="color: #333333;"> </span><span style="color: #868B44;">of</span><span style="color: #333333;"> </span><span style="color: #868B44;">matches</span><span style="color: #333333;"> </span><span style="color: #868B44;">--</span><span style="color: #333333;"> </span><span style="color: #868B44;">index</span><span style="color: #333333;"> </span><span style="color: #868B44;">of</span>
<span class="linenr">584: </span><span style="color: #868B44;">--</span><span style="color: #333333;"> </span><span style="color: #868B44;">start</span><span style="color: #333333;"> </span><span style="color: #868B44;">and</span><span style="color: #333333;"> </span><span style="color: #868B44;">the</span><span style="color: #333333;"> </span><span style="color: #868B44;">next</span><span style="color: #333333;"> </span><span style="color: #868B44;">char</span><span style="color: #333333;"> </span><span style="color: #868B44;">after</span><span style="color: #333333;"> </span><span style="color: #868B44;">the</span><span style="color: #333333;"> </span><span style="color: #868B44;">match.</span>
<span class="linenr">585: </span><span style="color: #8AAFFA;">findSubstring</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Eq</span><span style="color: #333333;"> </span>a)<span style="color: #333333;"> </span><span style="color: #A197BF;">=&gt;</span><span style="color: #333333;"> </span>[a]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[a]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[(<span style="color: #EF5C5F;">Int</span>,<span style="color: #333333;"> </span>[a],<span style="color: #333333;"> </span>a)]
<span class="linenr">586: </span><span style="color: #8AAFFA;">findSubstring</span><span style="color: #333333;"> </span>t<span style="color: #333333;"> </span>pat<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">587: </span><span style="color: #333333;">    </span>mapMaybe<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>(i,m)<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>guard<span style="color: #333333;"> </span>(pat<span style="color: #333333;"> </span><span style="color: #A197BF;">`isPrefixOf`</span><span style="color: #333333;"> </span>m)<span style="color: #333333;"> </span><span style="color: #A197BF;">&gt;&gt;</span><span style="color: #333333;"> </span>pure<span style="color: #333333;"> </span>(i,<span style="color: #333333;"> </span>m,<span style="color: #333333;"> </span>last<span style="color: #333333;"> </span>m))<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">588: </span><span style="color: #333333;">    </span>map<span style="color: #333333;"> </span>(second<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>take<span style="color: #333333;"> </span>l)<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">589: </span><span style="color: #333333;">    </span>filter<span style="color: #333333;"> </span>((<span style="color: #A197BF;">&gt;=</span><span style="color: #333333;"> </span>l)<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span><span style="color: #333333;"> </span>snd)<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span>
<span class="linenr">590: </span><span style="color: #333333;">    </span>[0<span style="color: #A197BF;">..</span>]<span style="color: #333333;"> </span><span style="color: #A197BF;">`zip`</span><span style="color: #333333;"> </span>tails<span style="color: #333333;"> </span>t
<span class="linenr">591: </span><span style="color: #333333;">  </span><span style="color: #FFA070;">where</span>
<span class="linenr">592: </span><span style="color: #333333;">    </span>l<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>pat<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>1
<span class="linenr">593: </span>
<span class="linenr">594: </span><span style="color: #8AAFFA;">execPpm</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>((<span style="color: #EF5C5F;">()</span>,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">PpmState</span>),<span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">PpmTrace</span>])
<span class="linenr">595: </span><span style="color: #8AAFFA;">execPpm</span><span style="color: #333333;"> </span>d<span style="color: #333333;"> </span>x<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>runWriter<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>(runStateT<span style="color: #333333;"> </span>(ppmCalculate<span style="color: #333333;"> </span>d<span style="color: #333333;"> </span>x<span style="color: #333333;"> </span>0)<span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">PpmState</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span>0))
<span class="linenr">596: </span>
<span class="linenr">597: </span><span style="color: #8AAFFA;">ppmBytes</span><span style="color: #333333;"> </span>p<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>1<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>ceiling<span style="color: #333333;"> </span>(_pGLog<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>snd<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>fst<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>execPpm<span style="color: #333333;"> </span>w<span style="color: #333333;"> </span>p)
<span class="linenr">598: </span>
<span class="linenr">599: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">600: </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">Burrows-Wheeler</span>
<span class="linenr">601: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">602: </span>
<span class="linenr">603: </span><span style="color: #8AAFFA;">bwTransform</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Show</span><span style="color: #333333;"> </span>a,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">Ord</span><span style="color: #333333;"> </span>a)<span style="color: #333333;"> </span><span style="color: #A197BF;">=&gt;</span><span style="color: #333333;"> </span>[a]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>([a],<span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>)
<span class="linenr">604: </span><span style="color: #8AAFFA;">bwTransform</span><span style="color: #333333;"> </span>input<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>(lastCol,<span style="color: #333333;"> </span>fromJust<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>findIndex<span style="color: #333333;"> </span>(<span style="color: #A197BF;">==</span>input)<span style="color: #333333;"> </span>mapped)
<span class="linenr">605: </span><span style="color: #333333;">  </span><span style="color: #FFA070;">where</span>
<span class="linenr">606: </span><span style="color: #333333;">    </span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>input
<span class="linenr">607: </span><span style="color: #333333;">    </span>cycled<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>cycle<span style="color: #333333;"> </span>input
<span class="linenr">608: </span><span style="color: #333333;">    </span>mapped<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>sort<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>map<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>take<span style="color: #333333;"> </span>n<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>drop<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>cycled)<span style="color: #333333;"> </span>[0<span style="color: #A197BF;">..</span>n<span style="color: #A197BF;">-</span>1]
<span class="linenr">609: </span><span style="color: #333333;">    </span>lastCol<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>map<span style="color: #333333;"> </span>last<span style="color: #333333;"> </span>mapped
<span class="linenr">610: </span>
<span class="linenr">611: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfState</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfState</span>
<span class="linenr">612: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>_mtfLetters<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]
<span class="linenr">613: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>_mtfOutput<span style="color: #333333;">  </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">614: </span><span style="color: #333333;">    </span>}<span style="color: #333333;"> </span><span style="color: #FFA070;">deriving</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span>
<span class="linenr">615: </span>
<span class="linenr">616: </span><span style="color: #8AAFFA;">makeLenses</span><span style="color: #333333;"> </span>''<span style="color: #EF5C5F;">MtfState</span>
<span class="linenr">617: </span>
<span class="linenr">618: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfTrace</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfTrace</span>
<span class="linenr">619: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>mtfCurChar<span style="color: #333333;">   </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Char</span>
<span class="linenr">620: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>mtfNew<span style="color: #333333;">       </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Bool</span>
<span class="linenr">621: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>mtfDist<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">622: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>mtfDiff<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">623: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>mtfCodeWord<span style="color: #333333;">  </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>]
<span class="linenr">624: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>mtfBits<span style="color: #333333;">      </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">625: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>mtfMsgLength<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span>
<span class="linenr">626: </span><span style="color: #333333;">    </span>}
<span class="linenr">627: </span>
<span class="linenr">628: </span><span style="color: #FFA070;">instance</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfTrace</span><span style="color: #333333;"> </span><span style="color: #FFA070;">where</span>
<span class="linenr">629: </span><span style="color: #333333;">    </span>show<span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfTrace</span><span style="color: #333333;"> </span>{<span style="color: #A197BF;">..</span>}<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">630: </span><span style="color: #333333;">        </span>intercalate
<span class="linenr">631: </span><span style="color: #333333;">            </span><span style="color: #868B44;">"|"</span>
<span class="linenr">632: </span><span style="color: #333333;">            </span>[<span style="color: #333333;"> </span><span style="color: #868B44;">""</span>
<span class="linenr">633: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>[mtfCurChar]
<span class="linenr">634: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>showBool<span style="color: #333333;"> </span>mtfNew
<span class="linenr">635: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>mtfDist
<span class="linenr">636: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>mtfDiff
<span class="linenr">637: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>concatMap<span style="color: #333333;"> </span>showBool<span style="color: #333333;"> </span>mtfCodeWord
<span class="linenr">638: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>mtfBits
<span class="linenr">639: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span>show<span style="color: #333333;"> </span>mtfMsgLength
<span class="linenr">640: </span><span style="color: #333333;">            </span>,<span style="color: #333333;"> </span><span style="color: #868B44;">""</span>
<span class="linenr">641: </span><span style="color: #333333;">            </span>]
<span class="linenr">642: </span><span style="color: #333333;">      </span><span style="color: #FFA070;">where</span>
<span class="linenr">643: </span><span style="color: #333333;">        </span>showBool<span style="color: #333333;"> </span><span style="color: #EF5C5F;">False</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">"0"</span>
<span class="linenr">644: </span><span style="color: #333333;">        </span>showBool<span style="color: #333333;"> </span><span style="color: #EF5C5F;">True</span><span style="color: #333333;">  </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #868B44;">"1"</span>
<span class="linenr">645: </span>
<span class="linenr">646: </span><span style="color: #FFA070;">type</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfM</span><span style="color: #333333;"> </span>a<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">StateT</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfState</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Writer</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">MtfTrace</span>])<span style="color: #333333;"> </span>a
<span class="linenr">647: </span>
<span class="linenr">648: </span>
<span class="linenr">649: </span><span style="color: #8AAFFA;">findIndexLast</span><span style="color: #333333;"> </span>pred<span style="color: #333333;"> </span>xs<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">650: </span><span style="color: #333333;">    </span>(<span style="color: #A197BF;">\</span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>xs<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>1)<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;$&gt;</span><span style="color: #333333;"> </span>(findIndex<span style="color: #333333;"> </span>pred<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>reverse<span style="color: #333333;"> </span>xs)
<span class="linenr">651: </span>
<span class="linenr">652: </span><span style="color: #868B44;">--</span><span style="color: #333333;"> </span><span style="color: #868B44;">|</span><span style="color: #333333;"> </span><span style="color: #868B44;">MTF</span><span style="color: #333333;"> </span><span style="color: #868B44;">encoding,</span><span style="color: #333333;"> </span><span style="color: #868B44;">straight-forward</span>
<span class="linenr">653: </span><span style="color: #8AAFFA;">mtfEncode</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>])<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfM</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">654: </span><span style="color: #8AAFFA;">mtfEncode</span><span style="color: #333333;"> </span><span style="color: #FFA070;">_</span><span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">|</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">&gt;=</span><span style="color: #333333;"> </span>BS.length<span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>pure<span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">655: </span><span style="color: #8AAFFA;">mtfEncode</span><span style="color: #333333;"> </span>u<span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">656: </span><span style="color: #333333;">    </span>history<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>use<span style="color: #333333;"> </span>mtfLetters
<span class="linenr">657: </span><span style="color: #333333;">    </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>c<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>BS.index<span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span>i
<span class="linenr">658: </span><span style="color: #333333;">        </span>mtfNew<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>not<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>c<span style="color: #333333;"> </span><span style="color: #A197BF;">`elem`</span><span style="color: #333333;"> </span>history
<span class="linenr">659: </span><span style="color: #333333;">        </span>foundIx<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>findIndexLast<span style="color: #333333;"> </span>(<span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>c)<span style="color: #333333;"> </span>history
<span class="linenr">660: </span><span style="color: #333333;">        </span>diffAbsent<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>nub<span style="color: #333333;"> </span>history)<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>256<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span>c
<span class="linenr">661: </span><span style="color: #333333;">        </span>diffPresent<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>nub<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>drop<span style="color: #333333;"> </span>(i<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>1)<span style="color: #333333;"> </span>history
<span class="linenr">662: </span><span style="color: #333333;">        </span>diff<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>maybe<span style="color: #333333;"> </span>diffAbsent<span style="color: #333333;"> </span>diffPresent<span style="color: #333333;"> </span>foundIx
<span class="linenr">663: </span><span style="color: #333333;">        </span>distAbsent<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span>history<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>256<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span>c
<span class="linenr">664: </span><span style="color: #333333;">        </span>dist<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>maybe<span style="color: #333333;"> </span>distAbsent<span style="color: #333333;"> </span>(<span style="color: #A197BF;">\</span>j<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">-</span><span style="color: #333333;"> </span>j<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>1)<span style="color: #333333;"> </span>foundIx
<span class="linenr">665: </span><span style="color: #333333;">        </span>codeWord<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>u<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>diff<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>1
<span class="linenr">666: </span><span style="color: #333333;">    </span>mtfOutput<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>codeWord
<span class="linenr">667: </span><span style="color: #333333;">    </span>mtfLetters<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>[c]
<span class="linenr">668: </span><span style="color: #333333;">    </span>mtfMsgLength<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>uses<span style="color: #333333;"> </span>mtfOutput<span style="color: #333333;"> </span>length
<span class="linenr">669: </span><span style="color: #333333;">    </span>tell<span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">MtfTrace</span><span style="color: #333333;"> </span>(chr<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span>c)<span style="color: #333333;"> </span>mtfNew<span style="color: #333333;"> </span>dist<span style="color: #333333;"> </span>diff<span style="color: #333333;"> </span>codeWord<span style="color: #333333;"> </span>(length<span style="color: #333333;"> </span>codeWord)<span style="color: #333333;"> </span>mtfMsgLength]
<span class="linenr">670: </span><span style="color: #333333;">    </span>mtfEncode<span style="color: #333333;"> </span>u<span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>succ<span style="color: #333333;"> </span>i
<span class="linenr">671: </span>
<span class="linenr">672: </span>
<span class="linenr">673: </span><span style="color: #8AAFFA;">execMtf</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">Int</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Bool</span>])<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span>((<span style="color: #EF5C5F;">()</span>,<span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfState</span>),<span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">MtfTrace</span>])
<span class="linenr">674: </span><span style="color: #8AAFFA;">execMtf</span><span style="color: #333333;"> </span>u<span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>runWriter<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>(runStateT<span style="color: #333333;"> </span>(mtfEncode<span style="color: #333333;"> </span>u<span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span>0)<span style="color: #333333;"> </span>(<span style="color: #EF5C5F;">MtfState</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span>))
<span class="linenr">675: </span>
<span class="linenr">676: </span>
<span class="linenr">677: </span>
<span class="linenr">678: </span><span style="color: #FFA070;">data</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfSimpleState</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfSimpleState</span>
<span class="linenr">679: </span><span style="color: #333333;">    </span>{<span style="color: #333333;"> </span>_mtfsLetters<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]
<span class="linenr">680: </span><span style="color: #333333;">    </span>,<span style="color: #333333;"> </span>_mtfsOutput<span style="color: #333333;">  </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]
<span class="linenr">681: </span><span style="color: #333333;">    </span>}<span style="color: #333333;"> </span><span style="color: #FFA070;">deriving</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Show</span>
<span class="linenr">682: </span>
<span class="linenr">683: </span><span style="color: #8AAFFA;">makeLenses</span><span style="color: #333333;"> </span>''<span style="color: #EF5C5F;">MtfSimpleState</span>
<span class="linenr">684: </span>
<span class="linenr">685: </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">Just</span><span style="color: #333333;"> </span><span style="color: #637579;">forms</span><span style="color: #333333;"> </span><span style="color: #637579;">the</span><span style="color: #333333;"> </span><span style="color: #637579;">string</span><span style="color: #333333;"> </span><span style="color: #637579;">for</span><span style="color: #333333;"> </span><span style="color: #637579;">encoding</span><span style="color: #333333;"> </span><span style="color: #637579;">with</span><span style="color: #333333;"> </span><span style="color: #637579;">enumerative</span><span style="color: #333333;"> </span><span style="color: #637579;">later</span>
<span class="linenr">686: </span><span style="color: #8AAFFA;">mtfEncodeEsc</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span>[<span style="color: #EF5C5F;">Word8</span>]<span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">State</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfSimpleState</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">687: </span><span style="color: #8AAFFA;">mtfEncodeEsc</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>pure<span style="color: #333333;"> </span><span style="color: #EF5C5F;">()</span>
<span class="linenr">688: </span><span style="color: #8AAFFA;">mtfEncodeEsc</span><span style="color: #333333;"> </span>(c<span style="color: #EF5C5F;">:</span>xs)<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span><span style="color: #FFA070;">do</span>
<span class="linenr">689: </span><span style="color: #333333;">    </span>history<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;-</span><span style="color: #333333;"> </span>use<span style="color: #333333;"> </span>mtfsLetters
<span class="linenr">690: </span><span style="color: #333333;">    </span><span style="color: #FFA070;">let</span><span style="color: #333333;"> </span>foundIx<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>findIndexLast<span style="color: #333333;"> </span>(<span style="color: #A197BF;">==</span><span style="color: #333333;"> </span>c)<span style="color: #333333;"> </span>history
<span class="linenr">691: </span><span style="color: #333333;">        </span>diffAbsent<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>ord<span style="color: #333333;"> </span><span style="color: #868B44;">'\\'</span>
<span class="linenr">692: </span><span style="color: #333333;">        </span>diffPresent<span style="color: #333333;"> </span>i<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>fromIntegral<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>length<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>nub<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>drop<span style="color: #333333;"> </span>(i<span style="color: #333333;"> </span><span style="color: #A197BF;">+</span><span style="color: #333333;"> </span>1)<span style="color: #333333;"> </span>history
<span class="linenr">693: </span><span style="color: #333333;">        </span>diff<span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">Word8</span>
<span class="linenr">694: </span><span style="color: #333333;">        </span>diff<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>maybe<span style="color: #333333;"> </span>diffAbsent<span style="color: #333333;"> </span>diffPresent<span style="color: #333333;"> </span>foundIx
<span class="linenr">695: </span><span style="color: #333333;">    </span>mtfsOutput<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>[diff]
<span class="linenr">696: </span><span style="color: #333333;">    </span>mtfsLetters<span style="color: #333333;"> </span><span style="color: #A197BF;">&lt;&gt;=</span><span style="color: #333333;"> </span>[c]
<span class="linenr">697: </span><span style="color: #333333;">    </span>mtfEncodeEsc<span style="color: #333333;"> </span>xs
<span class="linenr">698: </span>
<span class="linenr">699: </span><span style="color: #8AAFFA;">runMtfs</span><span style="color: #333333;"> </span>bs<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>execState<span style="color: #333333;"> </span>(mtfEncodeEsc<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span>BS.unpack<span style="color: #333333;"> </span>bs)<span style="color: #333333;"> </span><span style="color: #A197BF;">$</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">MtfSimpleState</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">[]</span>
<span class="linenr">700: </span>
<span class="linenr">701: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">702: </span><span style="color: #637579;">--</span><span style="color: #333333;"> </span><span style="color: #637579;">Zlib/Gzip</span>
<span class="linenr">703: </span><span style="color: #637579;">--</span><span style="color: #637579;">--------------------------------------------------------------------------</span>
<span class="linenr">704: </span>
<span class="linenr">705: </span><span style="color: #8AAFFA;">gzipCompress</span><span style="color: #333333;"> </span><span style="color: #A197BF;">::</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span><span style="color: #333333;"> </span><span style="color: #A197BF;">-&gt;</span><span style="color: #333333;"> </span><span style="color: #EF5C5F;">ByteString</span>
<span class="linenr">706: </span><span style="color: #8AAFFA;">gzipCompress</span><span style="color: #333333;"> </span><span style="color: #A197BF;">=</span>
<span class="linenr">707: </span><span style="color: #333333;">    </span>BSL.toStrict<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span>
<span class="linenr">708: </span><span style="color: #333333;">    </span>Z.compressWith
<span class="linenr">709: </span><span style="color: #333333;">        </span>(Z.defaultCompressParams
<span class="linenr">710: </span><span style="color: #333333;">         </span>{<span style="color: #333333;"> </span>compressLevel<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>Z.bestCompression
<span class="linenr">711: </span><span style="color: #333333;">         </span>,<span style="color: #333333;"> </span>compressMemoryLevel<span style="color: #333333;"> </span><span style="color: #A197BF;">=</span><span style="color: #333333;"> </span>Z.maxMemoryLevel
<span class="linenr">712: </span><span style="color: #333333;">         </span>})<span style="color: #333333;"> </span><span style="color: #A197BF;">.</span>
<span class="linenr">713: </span><span style="color: #333333;">    </span>BSL.fromStrict
</pre>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Volkhov Mikhail, M3338</p>
<p class="date">Created: 2016-12-18 Sun 17:00</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
